<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Push Notifications</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
</head>
<body>
  <h1>Firebase Push Notifications</h1>
  
  <section>
    <h2>Subscribe to a Topic</h2>
    <p>Enter a topic name and subscribe to receive notifications.</p>
    <label for="subscribeTopic">Topic Name:</label>
    <input type="text" id="subscribeTopic" placeholder="e.g., news-updates">
    <button id="subscribeBtn">Subscribe</button>
    <p id="subscribeStatus"></p>
  </section>
  
  <section>
    <h2>Send Notification to a Topic</h2>
    <p>Enter a topic name and notification details to send a push notification.</p>
    <label for="sendTopic">Topic Name:</label>
    <input type="text" id="sendTopic" placeholder="e.g., news-updates"><br><br>
    <label for="title">Title:</label>
    <input type="text" id="title" placeholder="Notification Title"><br><br>
    <label for="body">Body:</label>
    <input type="text" id="body" placeholder="Notification Body"><br><br>
    <label for="icon">Icon URL (optional):</label>
    <input type="text" id="icon" placeholder="https://example.com/icon.png"><br><br>
    <button id="sendBtn">Send Notification</button>
    <p id="sendStatus"></p>
  </section>

<script>
  // Replace with your Firebase config from the Firebase Console
  const firebaseConfig = {
  apiKey: "AIzaSyDh42r7F7lTAydfxMjQEejvwov9VN6ubVc",
  authDomain: "notis-b1899.firebaseapp.com",
  projectId: "notis-b1899",
  storageBucket: "notis-b1899.firebasestorage.app",
  messagingSenderId: "85368038648",
  appId: "1:85368038648:web:e946fdf8bc61c3e715470d"
  };

  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  let swReg;  // Store the registration globally for reuse if needed

  // Register the service worker and store the registration
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/fbsw.js')
      .then(reg => {
        console.log('Service worker registered', reg);
        swReg = reg;  // Save for use in getToken
      })
      .catch(err => console.error('Service worker registration failed', err));
  }

  // Worker URL - Replace with your Cloudflare Worker URL
  const workerUrl = 'https://firebase-notifications-worker.ynsgvls.workers.dev';

  // Subscribe functionality
  const subscribeBtn = document.getElementById('subscribeBtn');
  const subscribeTopicInput = document.getElementById('subscribeTopic');
  const subscribeStatusP = document.getElementById('subscribeStatus');

  subscribeBtn.addEventListener('click', async () => {
  const topic = subscribeTopicInput.value.trim();
  if (!topic) {
    subscribeStatusP.textContent = 'Please enter a topic name.';
    return;
  }

  try {
    // Request permission first
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      subscribeStatusP.textContent = 'Notification permission denied.';
      return;
    }

    // Wait for service worker registration if not ready
    if (!swReg) {
      subscribeStatusP.textContent = 'Service worker still registering... Try again in a second.';
      return;
    }

    // Get the FCM token (this is where we actually get 'token')
    const token = await messaging.getToken({
      vapidKey: 'BEE_1cxNWPCBZX8BiUF69F-I8VEHS-nvHhB8dgbWv0GP-OE0-l4DIYiQDDslIxWfzZX6i9035q4t7a_lubjfjc8',           // â† must be correct public VAPID key
      serviceWorkerRegistration: swReg
    });

if (!token) {
    subscribeStatusP.textContent = 'Failed to retrieve FCM token.';
    return;
  }

  console.log('FCM Token obtained:', token);

  // Call YOUR Worker to subscribe (this uses server auth)
  const response = await fetch(`${workerUrl}/subscribe`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token, topic })
  });

  if (response.ok) {
    subscribeStatusP.textContent = `Subscribed to topic "${topic}" via server!`;
  } else {
    const errText = await response.text();
    subscribeStatusP.textContent = `Subscription failed: ${errText}`;
  }

} catch (err) {
  subscribeStatusP.textContent = `Error: ${err.message || 'Unknown error'}`;
  console.error('Full subscribe error:', err);
}
});

  // Send functionality (unchanged)
  const sendBtn = document.getElementById('sendBtn');
  const sendTopicInput = document.getElementById('sendTopic');
  const titleInput = document.getElementById('title');
  const bodyInput = document.getElementById('body');
  const iconInput = document.getElementById('icon');
  const sendStatusP = document.getElementById('sendStatus');

  sendBtn.addEventListener('click', async () => {
    const topic = sendTopicInput.value.trim();
    const title = titleInput.value.trim();
    const body = bodyInput.value.trim();
    const icon = iconInput.value.trim();

    if (!topic || !title || !body) {
      sendStatusP.textContent = 'Please fill in topic, title, and body.';
      return;
    }

    const notification = { title, body };
    if (icon) notification.icon = icon;

    try {
      // Send to /send endpoint
      const response = await fetch(`${workerUrl}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic, notification })
      });

      if (response.ok) {
        sendStatusP.textContent = `Notification sent to topic: ${topic}`;
      } else {
        const err = await response.text();
        sendStatusP.textContent = `Error: ${err}`;
      }
    } catch (err) {
      sendStatusP.textContent = `Error: ${err.message}`;
      console.error(err);
    }
  });

  // Optional: Handle foreground messages
  messaging.onMessage((payload) => {
    console.log('Foreground message received:', payload);
    const notificationTitle = payload.notification.title;
    const notificationOptions = {
      body: payload.notification.body,
      icon: payload.notification.icon
    };
    new Notification(notificationTitle, notificationOptions);
  });
</script>
</body>
</html>



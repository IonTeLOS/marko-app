<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arweave Transaction Dispatcher</title>

  <script src="https://unpkg.com/arweave@1.15.1/bundles/web.bundle.min.js"></script>
  <script type="module">
    import { ArweaveWebWallet } from "https://unpkg.com/arweave-wallet-connector@1.0.2/lib/index.js";
    window.ArweaveWebWallet = ArweaveWebWallet;
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }

    .wallet-options { display: grid; gap: 10px; margin-bottom: 25px; }
    .wallet-option {
      background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 8px;
      padding: 15px; cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; gap: 12px;
    }
    .wallet-option:hover { border-color: #667eea; background: #f0f4ff; }
    .wallet-option.active { border-color: #4caf50; background: #e8f5e9; }

    .wallet-icon { width: 40px; height: 40px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; background: white;
    }

    .wallet-info { flex: 1; }
    .wallet-name { font-weight: 600; color: #333; margin-bottom: 2px; }
    .wallet-desc { font-size: 12px; color: #666; }

    .wallet-status {
      background: #f0f4ff; border: 2px solid #667eea;
      border-radius: 8px; padding: 15px; margin-bottom: 25px;
    }
    .wallet-status.connected { background: #e8f5e9; border-color: #4caf50; }
    .status-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #667eea; }
    .wallet-status.connected .status-dot { background: #4caf50; }
    .wallet-address { font-size: 12px; color: #666; font-family: monospace; word-break: break-all; margin-top: 5px; }

    label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
    textarea, input {
      width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
      font-size: 14px; font-family: inherit; transition: border-color 0.3s;
    }
    textarea { resize: vertical; min-height: 120px; }
    textarea:focus, input:focus { outline: none; border-color: #667eea; }

    .char-count { font-size: 12px; color: #666; text-align: right; margin-top: 5px; }
    .char-count.warning { color: #f57c00; font-weight: 600; }
    .char-count.free { color: #4caf50; font-weight: 600; }

    button {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; border-radius: 8px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    button:active { transform: translateY(0); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

    .button-secondary {
      background: #f5f5f5; color: #333; border: 2px solid #e0e0e0;
    }
    .button-secondary:hover { background: #e0e0e0; }

    .result { margin-top: 25px; padding: 20px; border-radius: 8px; display: none; }
    .result.success { background: #e8f5e9; border: 2px solid #4caf50; display: block; }
    .result.error { background: #ffebee; border: 2px solid #f44336; display: block; }
    .result-title { font-weight: 600; margin-bottom: 10px; font-size: 16px; }
    .result.success .result-title { color: #2e7d32; }
    .result.error .result-title { color: #c62828; }
    .tx-link { word-break: break-all; color: #667eea; text-decoration: none; font-size: 14px; }
    .tx-link:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <div class="container">
    <h1>üì¶ Arweave Dispatcher</h1>
    <p class="subtitle">Post transactions to Arweave for FREE (under 100KB)</p>

    <div class="wallet-options">
      <div class="wallet-option" onclick="selectWalletType('extension')" id="extensionOption">
        <div class="wallet-icon">üîå</div>
        <div class="wallet-info">
          <div class="wallet-name">Browser Extension</div>
          <div class="wallet-desc">ArConnect or Wander Desktop Extension</div>
        </div>
      </div>
      <div class="wallet-option" onclick="selectWalletType('mobile')" id="mobileOption">
        <div class="wallet-icon">üì±</div>
        <div class="wallet-info">
          <div class="wallet-name">Mobile Wallet (arweave.app)</div>
          <div class="wallet-desc">Connect via QR code or browser redirect</div>
        </div>
      </div>
    </div>

    <div class="wallet-status" id="walletStatus" style="display: none;">
      <div class="status-header">
        <div class="status-dot"></div>
        <span id="statusText">Not connected</span>
      </div>
      <div class="wallet-address" id="walletAddress" style="display: none;"></div>
      <button onclick="disconnectWallet()" class="button-secondary" style="margin-top: 10px;">Disconnect</button>
    </div>

    <form id="dispatchForm" style="display: none;">
      <div class="form-group">
        <label for="data">Transaction Data</label>
        <textarea id="data" placeholder="Enter your data here..." required></textarea>
        <div class="char-count" id="charCount">0 bytes (0 KB)</div>
      </div>

      <button type="submit" id="dispatchBtn">üöÄ Dispatch Transaction (FREE)</button>
    </form>

    <div class="result" id="result"></div>
  </div>

  <script type="module">
    const arweave = Arweave.init({ host: "arweave.net", port: 443, protocol: "https" });
    const walletStatus = document.getElementById("walletStatus");
    const statusText = document.getElementById("statusText");
    const walletAddress = document.getElementById("walletAddress");
    const dispatchForm = document.getElementById("dispatchForm");
    const dispatchBtn = document.getElementById("dispatchBtn");
    const resultDiv = document.getElementById("result");
    const dataInput = document.getElementById("data");
    const charCount = document.getElementById("charCount");

    let walletAddr = null, walletConnected = false, walletType = null, webWallet = null;

    /* --- Hide extension option on mobile --- */
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isMobile) document.getElementById("extensionOption").style.display = "none";

    /* --- Auto-reconnect if redirected back --- */
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const ww = new window.ArweaveWebWallet({ name: "Arweave Dispatcher" });
        await ww.setUrl("arweave.app");
        const connected = ww.checkConnection && await ww.checkConnection();
        if (connected && ww.address) {
          webWallet = ww;
          walletAddr = ww.address;
          handleConnected();
        }
      } catch (err) { console.log("No wallet session to restore:", err.message); }
    });

    window.selectWalletType = async function (type) {
      walletType = type;
      document.getElementById("extensionOption").classList.remove("active");
      document.getElementById("mobileOption").classList.remove("active");

      if (type === "extension") {
        document.getElementById("extensionOption").classList.add("active");
        await connectExtension();
      } else {
        document.getElementById("mobileOption").classList.add("active");
        await connectMobile();
      }
    };

    async function connectExtension() {
      try {
        if (!window.arweaveWallet) {
          const ua = navigator.userAgent;
          const isFirefox = ua.includes("Firefox");
          const arconnectLink = isFirefox
            ? "https://addons.mozilla.org/firefox/addon/arconnect/"
            : "https://chrome.google.com/webstore/detail/arconnect/einnffiilpbdimgbiclabfndakjgpcch";
          const wanderLink = "https://www.wander.app/download?tab=download-browser";
          showResult("error", `
            <strong>No Arweave extension detected.</strong><br><br>
            <b>Install one of these:</b><br>
            üîó <a href="${arconnectLink}" target="_blank">ArConnect Extension</a><br>
            üíª <a href="${wanderLink}" target="_blank">Wander (Chrome / Edge / Brave)</a><br><br>
            <small>You can also connect via <b>arweave.app</b> on desktop.</small>
          `);
          return;
        }

        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "DISPATCH", "SIGN_TRANSACTION"]);
        walletAddr = await window.arweaveWallet.getActiveAddress();
        handleConnected();
      } catch (error) {
        console.error("Extension connection error:", error);
        showResult("error", `Failed to connect: ${error.message}`);
      }
    }

    async function connectMobile() {
      try {
        if (!window.ArweaveWebWallet) throw new Error("Wallet connector not loaded");

        webWallet = new window.ArweaveWebWallet({
          name: "Arweave Dispatcher",
          logo: "https://github.com/IonTeLOS/marko-app/blob/b32d1cc9a37c1c91755051140874cd52cbd3beb4/appLogo_192.png?raw=true",
        });

        await webWallet.setUrl("arweave.app");
        await webWallet.connect({
          permissions: ["ACCESS_ADDRESS", "DISPATCH"],
          redirectUrl: "https://marko-app.netlify.app/di2",
        });

        walletAddr = webWallet.address || "(unknown)";
        if (walletAddr === "(unknown)") {
          try {
            const res = await fetch("https://arweave.app/api/wallet");
            const { address } = await res.json();
            if (address) walletAddr = address;
          } catch (e) { console.warn("Could not fetch address from arweave.app", e); }
        }

        if (typeof webWallet.dispatch !== "function")
          throw new Error("Connected wallet does not support dispatch(). Please update your mobile wallet.");

        handleConnected();
      } catch (error) {
        console.error("Mobile connection error:", error);
        showResult("error", `Failed to connect: ${error.message}`);
      }
    }

    function handleConnected() {
      walletConnected = true;
      walletStatus.style.display = "block";
      walletStatus.classList.add("connected");
      statusText.textContent = "‚úÖ Connected";
      walletAddress.textContent = `Address: ${walletAddr}`;
      walletAddress.style.display = "block";
      dispatchForm.style.display = "block";
      showResult("success", "Wallet connected! You can now dispatch transactions under 100KB for free.");
    }

    window.disconnectWallet = async function () {
      try {
        if (walletType === "mobile" && webWallet) await webWallet.disconnect();
        else if (walletType === "extension" && window.arweaveWallet?.disconnect)
          await window.arweaveWallet.disconnect();
      } catch (e) { console.log("Disconnect error:", e); }

      walletConnected = false;
      walletType = null;
      walletStatus.classList.remove("connected");
      walletStatus.style.display = "none";
      walletAddress.style.display = "none";
      dispatchForm.style.display = "none";
      walletAddr = null;
      webWallet = null;
      document.getElementById("extensionOption").classList.remove("active");
      document.getElementById("mobileOption").classList.remove("active");
      resultDiv.style.display = "none";
    };

    dataInput.addEventListener("input", () => {
      const bytes = new Blob([dataInput.value]).size;
      const kb = (bytes / 1024).toFixed(2);
      if (bytes > 102400)
        charCount.className = "char-count warning", charCount.textContent = `${bytes} bytes (${kb} KB) - ‚ö†Ô∏è Too large!`;
      else
        charCount.className = "char-count free", charCount.textContent = `${bytes} bytes (${kb} KB) - ‚úÖ FREE`;
    });

    dispatchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!walletConnected) return showResult("error", "Please connect your wallet first.");

      const data = dataInput.value;
      const bytes = new Blob([data]).size;
      if (bytes > 102400) return showResult("error", "Transaction exceeds 100KB limit.");

      try {
        dispatchBtn.disabled = true;
        dispatchBtn.textContent = "Dispatching...";
        const tx = await arweave.createTransaction({ data });
        tx.addTag("App-Name", "ArweaveDispatcher");
        tx.addTag("Content-Type", "text/plain");

        const result = walletType === "extension"
          ? await window.arweaveWallet.dispatch(tx)
          : await webWallet.dispatch(tx);

        showResult("success", `
          <div class="result-title">‚úÖ Transaction Dispatched Successfully!</div>
          <p>Transaction ID: <strong>${result.id}</strong></p>
          <p><a href="https://viewblock.io/arweave/tx/${result.id}" target="_blank" class="tx-link">View on ViewBlock ‚Üí</a></p>
          <p><a href="https://arweave.net/${result.id}" target="_blank" class="tx-link">View Data ‚Üí</a></p>
        `);

        dispatchForm.reset();
        charCount.textContent = "0 bytes (0 KB)";
        charCount.className = "char-count";
      } catch (error) {
        console.error("Dispatch error:", error);
        showResult("error", `Failed to dispatch: ${error.message}`);
      } finally {
        dispatchBtn.disabled = false;
        dispatchBtn.textContent = "üöÄ Dispatch Transaction (FREE)";
      }
    });

    function showResult(type, message) {
      resultDiv.className = `result ${type}`;
      resultDiv.innerHTML = typeof message === "string"
        ? `<div class="result-title">${type === "error" ? "‚ùå Error" : "‚úÖ Success"}</div><p>${message}</p>`
        : message;
      resultDiv.style.display = "block";
    }
  </script>
</body>
</html>

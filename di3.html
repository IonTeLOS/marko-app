<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arweave Auto Dispatcher</title>

  <script src="https://unpkg.com/arweave@1.15.1/bundles/web.bundle.min.js"></script>
  <script type="module">
    import { ArweaveWebWallet } from "https://unpkg.com/arweave-wallet-connector@1.0.2/lib/index.js";
    window.ArweaveWebWallet = ArweaveWebWallet;
  </script>

  <style>
    :root {
      --bg: #f6f9fc;
      --fg: #222;
      --box: #fff;
      --shadow: rgba(0, 0, 0, 0.1);
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent: #667eea;
      --good: #4caf50;
      --warn: #f57c00;
    }
    [data-theme="dark"] {
      --bg: #0d1117;
      --fg: #e6edf3;
      --box: #161b22;
      --shadow: rgba(0, 0, 0, 0.4);
      --primary: linear-gradient(135deg, #4447aa 0%, #764ba2 100%);
      --accent: #9ea9ff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    .container {
      background: var(--box);
      border-radius: 12px;
      box-shadow: 0 20px 60px var(--shadow);
      padding: 40px;
      max-width: 650px;
      width: 100%;
      text-align: center;
      transition: background 0.3s, color 0.3s;
    }

    h1 { margin-bottom: 10px; font-size: 28px; }
    .subtitle { color: var(--accent); margin-bottom: 20px; font-size: 14px; }

    textarea, input {
      width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
      font-size: 14px; background: var(--box); color: var(--fg);
      transition: border-color 0.3s, background 0.3s, color 0.3s;
    }
    textarea { resize: vertical; min-height: 100px; }
    textarea:focus, input:focus { border-color: var(--accent); outline: none; }

    .form-group { margin-bottom: 15px; text-align: left; }

    button {
      width: 100%; padding: 12px; margin-top: 10px;
      background: var(--primary);
      color: white; border: none; border-radius: 8px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--shadow); }
    button:disabled { background: #aaa; cursor: not-allowed; }

    .button-secondary {
      background: #f5f5f5; color: #333; border: 2px solid #e0e0e0;
    }
    [data-theme="dark"] .button-secondary {
      background: #222; color: #ccc; border-color: #333;
    }

    .status {
      margin: 15px 0; padding: 12px; border-radius: 8px;
      background: #f5f5f5; border: 2px solid #ddd; font-size: 14px;
      word-break: break-all;
    }
    .status.connected { background: #e8f5e9; border-color: var(--good); color: var(--good); }
    [data-theme="dark"] .status { background: #1e2329; border-color: #333; }

    .tag-pair { display: flex; gap: 6px; margin-top: 6px; }
    .tag-pair input { flex: 1; }

    .actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .mini-btn {
      flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc;
      background: #f0f0f0; color: #333; cursor: pointer; transition: background 0.2s;
    }
    .mini-btn:hover { background: #ddd; }
    [data-theme="dark"] .mini-btn { background: #222; color: #ccc; border-color: #444; }
  </style>
</head>

<body>
  <div class="container">
    <h1>üì¶ Arweave Auto Dispatcher</h1>
    <p class="subtitle">Free dispatch (‚â§100 KB) via Arweave / Wander / arweave.app</p>

    <div class="status" id="walletStatus">‚è≥ Detecting wallet...</div>

    <form id="dispatchForm" style="display:none;">
      <div class="form-group">
        <label>Transaction Data:</label>
        <textarea id="data" placeholder="Enter your data..." required></textarea>
        <div id="charCount" style="font-size:12px;text-align:right;"></div>
      </div>

      <div class="form-group">
        <label>Custom Tags (optional):</label>
        <div id="tags"></div>
        <button type="button" id="addTag" class="button-secondary">+ Add Tag</button>
      </div>

      <button id="dispatchBtn" type="submit">üöÄ Dispatch Transaction (FREE)</button>
      <button id="disconnectBtn" type="button" class="button-secondary">üîí Disconnect Wallet</button>
    </form>

    <div class="result" id="result"></div>

    <button id="themeToggle" class="button-secondary" style="margin-top:20px;">üåì Toggle Theme</button>
  </div>

  <script type="module">
  const arweave = Arweave.init({ host: "arweave.net", port: 443, protocol: "https" });
  const walletStatus = document.getElementById("walletStatus");
  const dispatchForm = document.getElementById("dispatchForm");
  const dataInput = document.getElementById("data");
  const charCount = document.getElementById("charCount");
  const resultDiv = document.getElementById("result");
  const dispatchBtn = document.getElementById("dispatchBtn");
  const disconnectBtn = document.getElementById("disconnectBtn");
  const tagsContainer = document.getElementById("tags");
  const addTagBtn = document.getElementById("addTag");
  const themeToggle = document.getElementById("themeToggle");

  let wallet, walletAddr, walletType = null;
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const callbackUrl = "https://marko-app.netlify.app/di3";

  // ---------- Theme ----------
  const currentTheme = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", currentTheme);
  themeToggle.textContent = currentTheme === "dark" ? "üåû Light Mode" : "üåì Dark Mode";
  themeToggle.onclick = () => {
    const newTheme = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", newTheme);
    localStorage.setItem("theme", newTheme);
    themeToggle.textContent = newTheme === "dark" ? "üåû Light Mode" : "üåì Dark Mode";
  };

  // ---------- Tag helpers ----------
  addTagRow("App-Name", "ArweaveAutoDispatcher");
  addTagRow("Content-Type", "text/plain");
  addTagBtn.onclick = () => addTagRow();

  function addTagRow(name = "", value = "") {
    const row = document.createElement("div");
    row.className = "tag-pair";
    row.innerHTML = `<input placeholder="Tag Name" value="${name}"><input placeholder="Tag Value" value="${value}">`;
    tagsContainer.appendChild(row);
  }

  // ---------- Auto Connect ----------
  window.addEventListener("DOMContentLoaded", async () => {
    walletType = localStorage.getItem("walletType");
    if (walletType) walletType === "extension" ? await reconnectExtension() : await reconnectMobile();
    else await autoDetectWallet();
  });

  async function autoDetectWallet() {
    if (isMobile) await connectMobile();
    else if (window.arweaveWallet) await connectExtension();
    else await connectMobile();
  }

  async function connectExtension() {
    try {
      walletStatus.textContent = "üîå Connecting to ArConnect/Wander...";
      await window.arweaveWallet.connect(["ACCESS_ADDRESS", "DISPATCH"]);
      walletAddr = await window.arweaveWallet.getActiveAddress();
      walletType = "extension";
      localStorage.setItem("walletType", walletType);
      showConnected(walletAddr);
    } catch (err) {
      await connectMobile();
    }
  }

  async function reconnectExtension() {
    try {
      walletAddr = await window.arweaveWallet.getActiveAddress();
      if (walletAddr) showConnected(walletAddr);
      else throw new Error("No active extension session");
    } catch {
      await connectMobile();
    }
  }

  // ---------- Mobile connect with polling ----------
  async function connectMobile() {
    try {
      walletStatus.textContent = "üì± Connecting via arweave.app...";
      const webWallet = new window.ArweaveWebWallet({
        name: "Arweave Auto Dispatcher",
        logo: "https://github.com/IonTeLOS/marko-app/blob/b32d1cc9a37c1c91755051140874cd52cbd3beb4/appLogo_192.png?raw=true",
      });
      await webWallet.setUrl("arweave.app");

      // already connected?
      const existing = localStorage.getItem("arweave-wallet");
      if (existing) {
        wallet = webWallet;
        walletAddr = JSON.parse(existing)?.address || "(unknown)";
        walletType = "mobile";
        localStorage.setItem("walletType", walletType);
        return showConnected(walletAddr);
      }

      await webWallet.connect({
        permissions: ["ACCESS_ADDRESS", "DISPATCH"],
        redirectUrl: callbackUrl,
      });
      wallet = webWallet;
      walletAddr = webWallet.address || "(unknown)";
      walletType = "mobile";
      localStorage.setItem("walletType", walletType);
      showConnected(walletAddr);

      // if new tab was opened, poll for session appearance
      startSessionPoll();
    } catch (err) {
      showError("Could not connect to arweave.app: " + err.message);
    }
  }

  function startSessionPoll() {
    let attempts = 0;
    const timer = setInterval(() => {
      const session = localStorage.getItem("arweave-wallet");
      if (session) {
        const { address } = JSON.parse(session);
        if (address) {
          clearInterval(timer);
          showConnected(address);
        }
      }
      if (++attempts > 90) clearInterval(timer); // stop after 90s
    }, 1000);
  }

  async function reconnectMobile() {
    try {
      const webWallet = new window.ArweaveWebWallet({ name: "Arweave Auto Dispatcher" });
      await webWallet.setUrl("arweave.app");
      const session = localStorage.getItem("arweave-wallet");
      if (session) {
        wallet = webWallet;
        walletAddr = JSON.parse(session)?.address || "(unknown)";
        showConnected(walletAddr);
      } else {
        startSessionPoll();
      }
    } catch {
      await connectMobile();
    }
  }

  function showConnected(addr) {
    walletStatus.classList.add("connected");
    walletStatus.textContent = `‚úÖ Connected: ${addr}`;
    dispatchForm.style.display = "block";
  }

  // ---------- Form + Dispatch ----------
  dataInput.addEventListener("input", () => {
    const bytes = new Blob([dataInput.value]).size;
    const kb = (bytes / 1024).toFixed(2);
    charCount.textContent = `${bytes} bytes (${kb} KB)`;
    charCount.style.color = bytes > 102400 ? "var(--warn)" : "var(--good)";
  });

  dispatchForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = dataInput.value;
    const bytes = new Blob([data]).size;
    if (bytes > 102400) return showError("Transaction too large (max 100 KB).");

    const tags = {};
    document.querySelectorAll(".tag-pair").forEach(pair => {
      const k = pair.children[0].value.trim();
      const v = pair.children[1].value.trim();
      if (k && v) tags[k] = v;
    });

    try {
      dispatchBtn.disabled = true;
      dispatchBtn.textContent = "Dispatching...";
      const tx = await arweave.createTransaction({ data });
      for (const [k, v] of Object.entries(tags)) tx.addTag(k, v);
      const result =
        walletType === "extension"
          ? await window.arweaveWallet.dispatch(tx)
          : await wallet.dispatch(tx);
      showSuccess(result.id);
    } catch (err) {
      showError("Dispatch failed: " + err.message);
    } finally {
      dispatchBtn.disabled = false;
      dispatchBtn.textContent = "üöÄ Dispatch Transaction (FREE)";
    }
  });

  disconnectBtn.onclick = async () => {
    try {
      if (walletType === "mobile" && wallet?.disconnect) await wallet.disconnect();
      if (walletType === "extension" && window.arweaveWallet?.disconnect) await window.arweaveWallet.disconnect();
    } catch {}
    localStorage.removeItem("walletType");
    wallet = null; walletAddr = null; walletType = null;
    walletStatus.textContent = "üëã Disconnected. Reloading...";
    setTimeout(() => location.reload(), 800);
  };

  // ---------- Helpers ----------
  function showSuccess(id) {
    const url = `https://arweave.net/${id}`;
    resultDiv.className = "result success";
    resultDiv.innerHTML = `
      <div class="result-title">‚úÖ Transaction Dispatched!</div>
      <p><strong>ID:</strong> ${id}</p>
      <p><a class="tx-link" href="https://viewblock.io/arweave/tx/${id}" target="_blank">View on ViewBlock ‚Üí</a></p>
      <p><a class="tx-link" href="${url}" target="_blank">View Data ‚Üí</a></p>
      <div class="actions">
        <button type="button" class="mini-btn" id="copyBtn">üìã Copy Link</button>
        <button type="button" class="mini-btn" id="shareBtn">üì± Share</button>
      </div>`;
    resultDiv.style.display = "block";

    setTimeout(() => {
      const copyBtn = document.getElementById("copyBtn");
      const shareBtn = document.getElementById("shareBtn");
      copyBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(url);
          copyBtn.textContent = "‚úÖ Copied!";
          setTimeout(() => (copyBtn.textContent = "üìã Copy Link"), 2000);
        } catch (err) { alert("Failed to copy: " + err.message); }
      };
      if (navigator.share) {
        shareBtn.onclick = async () => {
          try {
            await navigator.share({ title: "Arweave Upload", text: "Check out my Arweave transaction", url });
          } catch {}
        };
      } else shareBtn.style.display = "none";
    }, 100);
  }

  function showError(msg) {
    resultDiv.className = "result error";
    resultDiv.innerHTML = `<div class="result-title">‚ùå Error</div><p>${msg}</p>`;
    resultDiv.style.display = "block";
  }
</script>
</body>
</html>

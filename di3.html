<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arweave Auto Dispatcher</title>

  <script src="https://unpkg.com/arweave@1.15.1/bundles/web.bundle.min.js"></script>
  <script type="module">
    import { ArweaveWebWallet } from "https://unpkg.com/arweave-wallet-connector@1.0.2/lib/index.js";
    window.ArweaveWebWallet = ArweaveWebWallet;
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
    .subtitle { color: #666; margin-bottom: 20px; font-size: 14px; }
    textarea {
      width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
      font-size: 14px; resize: vertical; min-height: 120px;
      font-family: inherit; transition: border-color 0.3s;
    }
    textarea:focus { border-color: #667eea; outline: none; }
    .char-count { font-size: 12px; margin-top: 5px; text-align: right; }
    .free { color: #4caf50; }
    .warn { color: #f57c00; }
    button {
      width: 100%; padding: 14px; margin-top: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; border-radius: 8px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .button-secondary {
      background: #f5f5f5; color: #333; border: 2px solid #e0e0e0; margin-top: 10px;
    }
    .button-secondary:hover { background: #e0e0e0; }
    .status {
      margin: 15px 0; padding: 12px; border-radius: 8px; background: #f5f5f5;
      border: 2px solid #ddd; font-size: 14px; word-break: break-all;
    }
    .status.connected { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
    .result { margin-top: 20px; display: none; padding: 15px; border-radius: 8px; }
    .result.success { background: #e8f5e9; border: 2px solid #4caf50; display: block; }
    .result.error { background: #ffebee; border: 2px solid #f44336; display: block; }
    a.tx-link { color: #667eea; text-decoration: none; }
    a.tx-link:hover { text-decoration: underline; }
    .actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .mini-btn {
      flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc;
      background: #f0f0f0; color: #333; cursor: pointer; transition: background 0.2s;
    }
    .mini-btn:hover { background: #ddd; }
  </style>
</head>

<body>
  <div class="container">
    <h1>üì¶ Arweave Auto Dispatcher</h1>
    <p class="subtitle">Automatically connects to your best wallet and dispatches transactions (‚â§100KB) for free.</p>

    <div class="status" id="walletStatus">‚è≥ Detecting wallet...</div>

    <form id="dispatchForm" style="display:none;">
      <textarea id="data" placeholder="Enter your data here..." required></textarea>
      <div class="char-count" id="charCount">0 bytes (0 KB)</div>
      <button id="dispatchBtn" type="submit">üöÄ Dispatch Transaction (FREE)</button>
      <button id="disconnectBtn" type="button" class="button-secondary">üîí Disconnect Wallet</button>
    </form>

    <div class="result" id="result"></div>
  </div>

  <script type="module">
    const arweave = Arweave.init({ host: "arweave.net", port: 443, protocol: "https" });
    const walletStatus = document.getElementById("walletStatus");
    const dispatchForm = document.getElementById("dispatchForm");
    const dataInput = document.getElementById("data");
    const charCount = document.getElementById("charCount");
    const resultDiv = document.getElementById("result");
    const dispatchBtn = document.getElementById("dispatchBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");

    let wallet, walletAddr, walletType = null;
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const callbackUrl = "https://marko-app.netlify.app/di";

    window.addEventListener("DOMContentLoaded", async () => {
      walletType = localStorage.getItem("walletType");
      if (walletType) {
        console.log("üîÅ Restoring wallet session:", walletType);
        walletType === "extension" ? await reconnectExtension() : await reconnectMobile();
      } else {
        await autoDetectWallet();
      }
    });

    async function autoDetectWallet() {
      if (isMobile) await connectMobile();
      else if (window.arweaveWallet) await connectExtension();
      else await connectMobile();
    }

    async function connectExtension() {
      try {
        walletStatus.textContent = "üîå Connecting to ArConnect/Wander...";
        await window.arweaveWallet.connect(["ACCESS_ADDRESS", "DISPATCH"]);
        walletAddr = await window.arweaveWallet.getActiveAddress();
        walletType = "extension";
        localStorage.setItem("walletType", walletType);
        showConnected(walletAddr);
      } catch (err) {
        console.warn("Extension connect failed:", err);
        await connectMobile();
      }
    }

    async function reconnectExtension() {
      try {
        walletStatus.textContent = "üîå Reconnecting extension...";
        walletAddr = await window.arweaveWallet.getActiveAddress();
        if (walletAddr) showConnected(walletAddr);
        else throw new Error("No active extension session found");
      } catch {
        await connectMobile();
      }
    }

    async function connectMobile() {
      try {
        walletStatus.textContent = "üì± Connecting via arweave.app...";
        const webWallet = new window.ArweaveWebWallet({
          name: "Arweave Auto Dispatcher",
          logo: "https://github.com/IonTeLOS/marko-app/blob/b32d1cc9a37c1c91755051140874cd52cbd3beb4/appLogo_192.png?raw=true",
        });
        await webWallet.setUrl("arweave.app");
        await webWallet.connect({
          permissions: ["ACCESS_ADDRESS", "DISPATCH"],
          redirectUrl: callbackUrl,
        });
        wallet = webWallet;
        walletAddr = webWallet.address || "(unknown)";
        walletType = "mobile";
        localStorage.setItem("walletType", walletType);
        showConnected(walletAddr);
      } catch (err) {
        console.error("Mobile connection failed:", err);
        showError("Could not connect to arweave.app. " + err.message);
      }
    }

    async function reconnectMobile() {
      try {
        walletStatus.textContent = "üì± Reconnecting arweave.app...";
        const webWallet = new window.ArweaveWebWallet({ name: "Arweave Auto Dispatcher" });
        await webWallet.setUrl("arweave.app");
        wallet = webWallet;
        walletAddr = webWallet.address || "(unknown)";
        if (!walletAddr || walletAddr === "(unknown)") throw new Error("Session expired");
        showConnected(walletAddr);
      } catch {
        await connectMobile();
      }
    }

    function showConnected(addr) {
      walletStatus.classList.add("connected");
      walletStatus.textContent = `‚úÖ Connected: ${addr}`;
      dispatchForm.style.display = "block";
    }

    dataInput.addEventListener("input", () => {
      const bytes = new Blob([dataInput.value]).size;
      const kb = (bytes / 1024).toFixed(2);
      charCount.textContent = `${bytes} bytes (${kb} KB)`;
      charCount.className = "char-count " + (bytes > 102400 ? "warn" : "free");
    });

    dispatchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = dataInput.value;
      const bytes = new Blob([data]).size;
      if (bytes > 102400) return showError("Transaction too large (max 100 KB).");

      try {
        dispatchBtn.disabled = true;
        dispatchBtn.textContent = "Dispatching...";
        const tx = await arweave.createTransaction({ data });
        tx.addTag("App-Name", "ArweaveAutoDispatcher");
        tx.addTag("Content-Type", "text/plain");

        const result =
          walletType === "extension"
            ? await window.arweaveWallet.dispatch(tx)
            : await wallet.dispatch(tx);

        showSuccess(result.id);
      } catch (err) {
        console.error("Dispatch error:", err);
        showError("Failed to dispatch: " + err.message);
      } finally {
        dispatchBtn.disabled = false;
        dispatchBtn.textContent = "üöÄ Dispatch Transaction (FREE)";
      }
    });

    disconnectBtn.addEventListener("click", async () => {
      try {
        if (walletType === "mobile" && wallet?.disconnect) await wallet.disconnect();
        if (walletType === "extension" && window.arweaveWallet?.disconnect)
          await window.arweaveWallet.disconnect();
      } catch (err) {
        console.warn("Error during disconnect:", err);
      }
      localStorage.removeItem("walletType");
      wallet = null;
      walletAddr = null;
      walletType = null;
      dispatchForm.style.display = "none";
      walletStatus.classList.remove("connected");
      walletStatus.textContent = "üëã Disconnected. Reloading...";
      setTimeout(() => location.reload(), 800);
    });

    function showSuccess(id) {
      const viewUrl = `https://arweave.net/${id}`;
      resultDiv.className = "result success";
      resultDiv.innerHTML = `
        <div class="result-title">‚úÖ Transaction Dispatched!</div>
        <p><strong>ID:</strong> ${id}</p>
        <p><a class="tx-link" href="https://viewblock.io/arweave/tx/${id}" target="_blank">View on ViewBlock ‚Üí</a></p>
        <p><a class="tx-link" href="${viewUrl}" target="_blank">View Data ‚Üí</a></p>
        <div class="actions">
          <button type="button" class="mini-btn" id="copyBtn">üìã Copy Link</button>
          <button type="button" class="mini-btn" id="shareBtn">üì± Share</button>
        </div>
      `;
      resultDiv.style.display = "block";

      setTimeout(() => {
        const copyBtn = document.getElementById("copyBtn");
        const shareBtn = document.getElementById("shareBtn");

        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(viewUrl);
            copyBtn.textContent = "‚úÖ Copied!";
            setTimeout(() => (copyBtn.textContent = "üìã Copy Link"), 2000);
          } catch (err) {
            alert("Failed to copy: " + err.message);
          }
        };

        if (navigator.share) {
          shareBtn.onclick = async () => {
            try {
              await navigator.share({
                title: "Arweave Upload",
                text: "Check out my Arweave transaction",
                url: viewUrl,
              });
            } catch (err) {
              console.warn("Share cancelled or failed", err);
            }
          };
        } else {
          shareBtn.style.display = "none";
        }
      }, 100);
    }

    function showError(msg) {
      resultDiv.className = "result error";
      resultDiv.innerHTML = `<div class="result-title">‚ùå Error</div><p>${msg}</p>`;
      resultDiv.style.display = "block";
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Arweave Pay (AR Sender)</title>

  <!-- Arweave SDK -->
  <script src="https://unpkg.com/arweave@1.15.1/bundles/web.bundle.min.js"></script>
  <!-- Wallet Connector for arweave.app (mobile) -->
  <script type="module">
    import { ArweaveWebWallet } from "https://unpkg.com/arweave-wallet-connector@1.0.2/lib/index.js";
    window.ArweaveWebWallet = ArweaveWebWallet;
  </script>

  <style>
    :root {
      --bg: #f6f9fc;
      --fg: #222;
      --box: #fff;
      --muted: #666;
      --shadow: rgba(0,0,0,.1);
      --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent: #667eea;
      --ok: #2e7d32;
      --warn: #ef6c00;
      --err: #c62828;
      --input-border: #ddd;
    }
    [data-theme="dark"] {
      --bg: #0d1117;
      --fg: #e6edf3;
      --box: #161b22;
      --muted: #9aa4ad;
      --shadow: rgba(0,0,0,.4);
      --primary-grad: linear-gradient(135deg, #4447aa 0%, #764ba2 100%);
      --accent: #9ea9ff;
      --input-border: #2a2f36;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,Cantarell,system-ui,sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
      transition: background .25s,color .25s;
    }
    .card {
      background: var(--box);
      box-shadow: 0 20px 60px var(--shadow);
      border-radius: 14px;
      width: 100%;
      max-width: 680px;
      padding: 28px;
    }
    h1 { margin: 0 0 6px; font-size: 26px; }
    .sub { margin: 0 0 18px; color: var(--muted); font-size: 14px; }
    .row { display: grid; gap: 10px; margin-bottom: 14px; }
    label { font-size: 13px; font-weight: 600; }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      background: var(--box);
      color: var(--fg);
      font-size: 14px;
      outline: none;
      transition: border-color .2s;
    }
    input:focus { border-color: var(--accent); }
    .inline { display: flex; gap: 10px; }
    .inline > * { flex: 1; }
    .pill {
      display: inline-flex; gap: 8px; align-items: center;
      padding: 8px 12px; border-radius: 999px; font-size: 13px;
      border: 2px solid var(--input-border); color: var(--muted);
    }
    .status { margin: 12px 0; padding: 12px; border-radius: 10px; font-size: 14px; }
    .status.ok { background: #e8f5e9; color: var(--ok); border: 2px solid var(--ok); }
    .status.warn { background: #fff3e0; color: var(--warn); border: 2px solid var(--warn); }
    .status.err { background: #ffebee; color: var(--err); border: 2px solid var(--err); }
    [data-theme="dark"] .status.ok { background: #16331a; }
    [data-theme="dark"] .status.warn { background: #3a2a15; }
    [data-theme="dark"] .status.err { background: #3b1b1d; }

    .btn {
      appearance: none; border: 0; cursor: pointer;
      padding: 13px 14px; border-radius: 10px; font-weight: 700;
      color: #fff; background: var(--primary-grad);
      width: 100%;
      transition: transform .15s, box-shadow .15s, opacity .2s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px var(--shadow); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-secondary {
      background: transparent; color: var(--fg);
      border: 2px solid var(--input-border);
    }

    .tags { display: grid; gap: 8px; }
    .tag-pair { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
    .muted { color: var(--muted); font-size: 12px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }

    .grid2 { display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items: end; }
    .link { color: var(--accent); text-decoration: none; }
    .right { text-align: right; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üí∏ Arweave Pay</h1>
    <p class="sub">Send AR to any Arweave address. Works with ArConnect/Wander (desktop) or arweave.app (mobile).</p>

    <div class="toolbar" style="justify-content: space-between; margin-bottom: 8px;">
      <span id="walletPill" class="pill">üîå Detecting wallet‚Ä¶</span>
      <div class="inline" style="flex: 0 0 auto; gap: 8px;">
        <button id="themeBtn" class="btn btn-secondary" style="width:auto;">üåì Theme</button>
        <button id="disconnectBtn" class="btn btn-secondary" style="width:auto; display:none;">üîí Disconnect</button>
      </div>
    </div>

    <div id="balanceBox" class="status">Checking balance‚Ä¶</div>

    <div class="row">
      <label for="toAddr">Recipient Address</label>
      <input id="toAddr" placeholder="Arweave address (base64url)" autocomplete="off"/>
    </div>

    <div class="row grid2">
      <div>
        <label for="amountAR">Amount (AR)</label>
        <input id="amountAR" placeholder="0.0" inputmode="decimal" autocomplete="off"/>
        <div class="muted">Safety buffer for ‚ÄúMax‚Äù: <strong>0.1 AR</strong></div>
      </div>
      <button id="maxBtn" class="btn btn-secondary" type="button" style="width:auto;">Max</button>
    </div>

    <div class="row">
      <label>Custom Tags (optional)</label>
      <div id="tags" class="tags"></div>
      <button id="addTag" class="btn btn-secondary" type="button">+ Add Tag</button>
      <div class="muted">Tags are written on-chain with the transaction.</div>
    </div>

    <div class="row">
      <button id="sendBtn" class="btn">üöÄ Send AR</button>
    </div>

    <div id="lowBalBox" class="status warn" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <div>Balance is under <strong>2 AR</strong>. You may need to top up.</div>
        <div class="inline" style="gap:8px;flex:0 0 auto;">
          <button id="copyMyAddr" class="btn btn-secondary" type="button" style="width:auto;">üìã Copy My Address</button>
          <a id="transakBtn" class="btn btn-secondary" style="width:auto;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;" target="_blank" rel="noopener" href="https://global.transak.com/">ü™ô Open Transak</a>
        </div>
      </div>
      <div class="muted">Transak availability of AR depends on your region/payment rails.</div>
    </div>

    <div id="resultBox" class="status" style="display:none;"></div>

    <div class="right" style="margin-top:10px;">
      <a href="https://viewblock.io/arweave/addresses" target="_blank" class="link">View Address Explorer ‚Üí</a>
    </div>
  </div>

  <script type="module">
    const arweave = Arweave.init({ host: "arweave.net", port: 443, protocol: "https" });
    const SAFETY_BUFFER_AR = 0.1;

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const walletPill = document.getElementById("walletPill");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const themeBtn = document.getElementById("themeBtn");

    const balanceBox = document.getElementById("balanceBox");
    const lowBalBox = document.getElementById("lowBalBox");
    const copyMyAddr = document.getElementById("copyMyAddr");

    const toAddr = document.getElementById("toAddr");
    const amountAR = document.getElementById("amountAR");
    const maxBtn = document.getElementById("maxBtn");

    const tagsDiv = document.getElementById("tags");
    const addTag = document.getElementById("addTag");
    const sendBtn = document.getElementById("sendBtn");
    const resultBox = document.getElementById("resultBox");

    let walletType = null;
    let wallet = null;
    let myAddress = null;
    let myBalanceAR = 0;

    // --- Theme persistence ---
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeBtn.onclick = () => {
      const now = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", now);
      localStorage.setItem("theme", now);
    };

    // --- Helper UI funcs ---
    function pill(text, icon="üîå") {
      walletPill.textContent = "";
      walletPill.innerHTML = `${icon} ${text}`;
    }
    function showResult(kind, html) {
      resultBox.className = "status " + (kind === "ok" ? "ok" : kind === "warn" ? "warn" : "err");
      resultBox.style.display = "block";
      resultBox.innerHTML = html;
    }
    function hideResult(){ resultBox.style.display="none"; }

    function addTagRow(name = "", value = "") {
      const row = document.createElement("div");
      row.className = "tag-pair";
      row.innerHTML = `
        <input placeholder="Tag name" value="${name}"/>
        <input placeholder="Tag value" value="${value}"/>
      `;
      tagsDiv.appendChild(row);
    }
    addTagRow("App-Name", "ArweavePay");
    addTagRow("Purpose", "Payment");
    addTag.onclick = () => addTagRow();

    // --- Wallet detection/connection ---
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const prev = localStorage.getItem("walletType");
        if (prev === "extension" && window.arweaveWallet) return await connectExtension(true);
        if (prev === "mobile") return await connectMobile(true);
        if (!isMobile && window.arweaveWallet) return await connectExtension(false);
        await connectMobile(false);
      } catch (e) {
        pill("No wallet detected", "‚ùå");
        balanceBox.className = "status err";
        balanceBox.innerHTML = "No wallet available. Install <a class='link' href='https://www.wander.app/download?tab=download-browser' target='_blank' rel='noopener'>Wander</a> or use arweave.app on mobile.";
      }
    });

    // --- Auto refresh balance if authorized ---
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        if (window.arweaveWallet) {
          const addr = await window.arweaveWallet.getActiveAddress().catch(() => null);
          if (addr) {
            wallet = window.arweaveWallet;
            walletType = "extension";
            myAddress = addr;
            disconnectBtn.style.display = "inline-block";
            await afterConnect();
          }
        }
      } catch (e) {
        console.warn("Auto-refresh balance failed:", e);
      }
    });

    async function connectExtension(reconnect) {
      try {
        pill(reconnect ? "Reconnecting extension‚Ä¶" : "Connecting extension‚Ä¶", "üîå");
        await window.arweaveWallet.connect(["ACCESS_ADDRESS","SIGN_TRANSACTION"]);
        myAddress = await window.arweaveWallet.getActiveAddress();
        wallet = window.arweaveWallet;
        walletType = "extension";
        localStorage.setItem("walletType","extension");
        disconnectBtn.style.display = "inline-block";
        await afterConnect();
      } catch (e) {
        if (!reconnect) return connectMobile(false);
        throw e;
      }
    }

    async function connectMobile(reconnect) {
      const callbackUrl = location.href;
      try {
        pill(reconnect ? "Reconnecting mobile‚Ä¶" : "Connecting mobile‚Ä¶", "üì±");
        const ww = new window.ArweaveWebWallet({ name: "Arweave Pay" });
        await ww.setUrl("arweave.app");
        if (!reconnect) {
          await ww.connect({
            permissions: ["ACCESS_ADDRESS","SIGN_TRANSACTION"],
            redirectUrl: callbackUrl,
          });
        }
        wallet = ww;
        myAddress = ww.address || "(unknown)";
        walletType = "mobile";
        localStorage.setItem("walletType","mobile");
        disconnectBtn.style.display = "inline-block";
        await afterConnect();
      } catch (e) {
        pill("Mobile connect failed", "‚ùå");
        showResult("err", `Could not connect to arweave.app: ${e.message}`);
      }
    }

    async function afterConnect() {
      pill(`Connected: ${short(myAddress)}`, "‚úÖ");
      try {
        const balWinston = await arweave.wallets.getBalance(myAddress);
        myBalanceAR = parseFloat(arweave.ar.winstonToAr(balWinston));
        const statusKind = myBalanceAR < 2 ? "warn" : "ok";
        balanceBox.className = "status " + statusKind;
        balanceBox.innerHTML = `
          <strong>My Address</strong><br>${myAddress}<br><br>
          <strong>Balance:</strong> ${myBalanceAR.toFixed(6)} AR<br>
          <span class="muted">${myBalanceAR < 2 ? "Low balance. Consider topping up." : "You‚Äôre good to go."}</span>
        `;
        if (myBalanceAR < 2) {
          lowBalBox.style.display = "block";
          copyMyAddr.onclick = async () => {
            await navigator.clipboard.writeText(myAddress);
            copyMyAddr.textContent = "‚úÖ Copied!";
            setTimeout(()=>copyMyAddr.textContent="üìã Copy My Address",1500);
          };
        } else lowBalBox.style.display = "none";
      } catch {
        balanceBox.className = "status err";
        balanceBox.textContent = "Failed to fetch balance.";
      }
    }

    // --- Helpers ---
    function short(addr) { return addr?.length > 20 ? addr.slice(0,10)+"‚Ä¶"+addr.slice(-8):addr; }
    function parseAmount(str) {
      const n = Number(String(str).trim().replace(",", "."));
      return Number.isFinite(n)&&n>=0?n:NaN;
    }
    function tagsFromUI() {
      const out=[]; tagsDiv.querySelectorAll(".tag-pair").forEach(pair=>{
        const k=pair.children[0].value.trim(); const v=pair.children[1].value.trim();
        if(k&&v) out.push([k,v]);
      }); return out;
    }

    maxBtn.onclick=()=>{ const usable=Math.max(0,myBalanceAR-0.1); amountAR.value=usable>0?usable.toFixed(6):"0.000000"; };

    disconnectBtn.onclick=async()=>{ try{
      if(walletType==="mobile"&&wallet?.disconnect)await wallet.disconnect();
      if(walletType==="extension"&&window.arweaveWallet?.disconnect)await window.arweaveWallet.disconnect();
    }catch{} localStorage.removeItem("walletType"); wallet=null; myAddress=null; walletType=null; location.reload(); };

    sendBtn.onclick=async()=>{
      hideResult();
      if(!wallet)return showResult("err","No wallet connected.");
      const target=toAddr.value.trim(); if(!target)return showResult("err","Please enter recipient.");
      const amt=parseAmount(amountAR.value); if(!Number.isFinite(amt)||amt<=0)return showResult("err","Invalid AR amount.");
      if(amt+SAFETY_BUFFER_AR>myBalanceAR)return showResult("err",`Amount+buffer > balance (${myBalanceAR.toFixed(6)} AR).`);
      try{
        sendBtn.disabled=true; sendBtn.textContent="Sending‚Ä¶";
        const quantity = arweave.ar.arToWinston(amt.toString());
        const tx = await arweave.createTransaction({ target, quantity });

        // Add custom tags
        for (const [k, v] of tagsFromUI()) {
          tx.addTag(k, v);
        }

        // --- Sign transaction ---
        if (walletType === "extension") {
          if (typeof wallet.signTransaction === "function") {
            await wallet.signTransaction(tx);
          } else if (typeof wallet.sign === "function") {
            await wallet.sign(tx);
          } else {
            throw new Error("Wallet does not expose signTransaction/sign");
          }
        } else {
          if (typeof wallet.signTransaction === "function") {
            await wallet.signTransaction(tx);
          } else if (typeof wallet.sign === "function") {
            await wallet.sign(tx);
          } else {
            throw new Error("Mobile wallet does not expose signTransaction/sign");
          }
        }

        // --- Post to gateway ---
        const res = await arweave.transactions.post(tx);
        if (res?.status && res.status >= 200 && res.status < 300) {
          const id = tx.id;
          showResult("ok", `
            ‚úÖ <strong>Transaction submitted!</strong><br><br>
            <strong>ID:</strong> ${id}<br>
            <a class="link" target="_blank" href="https://viewblock.io/arweave/tx/${id}">View on ViewBlock</a> &nbsp;‚Ä¢&nbsp;
            <a class="link" target="_blank" href="https://arweave.net/tx/${id}">Gateway status</a>
          `);

          // Update balance optimistically
          myBalanceAR = Math.max(0, myBalanceAR - amt);
          balanceBox.innerHTML = `
            <strong>My Address</strong><br>${myAddress}<br><br>
            <strong>Balance:</strong> ${myBalanceAR.toFixed(6)} AR<br>
            <span class="muted">(Estimated after transaction)</span>
          `;
        } else {
          const status = res?.status ?? "unknown";
          throw new Error(`Gateway returned status ${status}`);
        }
      } catch (e) {
        showResult("err", `Transaction failed: ${e.message}`);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "üöÄ Send AR";
      }
    };
  </script>
</body>
</html>

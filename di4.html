<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arweave Payment Dispatcher</title>
  <script src="https://unpkg.com/arweave@1.15.1/bundles/web.bundle.min.js"></script>
  <script type="module">
    import { ArweaveWebWallet } from "https://unpkg.com/arweave-wallet-connector@1.0.2/lib/index.js";
    window.ArweaveWebWallet = ArweaveWebWallet;
  </script>
  <style>
    :root {
      --bg: #f6f9fc; --fg: #222; --box: #fff;
      --shadow: rgba(0,0,0,0.1);
      --primary: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --accent: #667eea; --good: #4caf50; --warn: #f57c00;
    }
    [data-theme="dark"] {
      --bg: #0d1117; --fg: #e6edf3; --box: #161b22;
      --shadow: rgba(0,0,0,0.4);
      --primary: linear-gradient(135deg,#4447aa 0%,#764ba2 100%);
      --accent: #9ea9ff;
    }
    body {
      font-family: system-ui,sans-serif;
      background: var(--bg); color: var(--fg);
      min-height:100vh; display:flex; justify-content:center; align-items:center;
      padding:20px; transition:.3s;
    }
    .container {
      background:var(--box); border-radius:12px;
      box-shadow:0 20px 60px var(--shadow);
      padding:40px; max-width:600px; width:100%; text-align:center;
      transition:.3s;
    }
    h1 {font-size:26px;margin-bottom:10px}
    .subtitle {color:var(--accent);margin-bottom:20px}
    input {width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;
      background:var(--box);color:var(--fg);font-size:14px;transition:.3s;}
    input:focus{border-color:var(--accent);outline:none}
    .form-group{margin-bottom:15px;text-align:left}
    button{width:100%;padding:12px;margin-top:10px;background:var(--primary);
      color:white;border:none;border-radius:8px;font-weight:600;font-size:16px;
      cursor:pointer;transition:.2s;}
    button:hover{transform:translateY(-2px)}
    button:disabled{background:#aaa;cursor:not-allowed}
    .button-secondary{background:#f5f5f5;color:#333;border:2px solid #e0e0e0;}
    [data-theme="dark"] .button-secondary{background:#222;color:#ccc;border-color:#333;}
    .status{margin:15px 0;padding:12px;border-radius:8px;background:#f5f5f5;
      border:2px solid #ddd;font-size:14px;word-break:break-all;}
    .status.connected{background:#e8f5e9;border-color:var(--good);color:var(--good);}
    [data-theme="dark"] .status{background:#1e2329;border-color:#333;}
    .tag-pair{display:flex;gap:6px;margin-top:6px}
    .tag-pair input{flex:1}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;}
    .mini-btn{flex:1;padding:10px;border-radius:6px;border:1px solid #ccc;
      background:#f0f0f0;color:#333;cursor:pointer;transition:.2s;}
    .mini-btn:hover{background:#ddd}
    [data-theme="dark"] .mini-btn{background:#222;color:#ccc;border-color:#444;}
  </style>
</head>
<body>
<div class="container">
  <h1>üí∏ Arweave Payment Dispatcher</h1>
  <p class="subtitle">Send AR with custom tags via Arweave / Wander / arweave.app</p>

  <div class="status" id="walletStatus">‚è≥ Detecting wallet...</div>

  <form id="dispatchForm" style="display:none;">
    <div class="form-group">
      <label>Recipient Address:</label>
      <input id="target" placeholder="Enter recipient wallet address" required />
    </div>

    <div class="form-group">
      <label>Amount (in AR):</label>
      <input id="amount" type="number" step="0.000001" min="0" placeholder="e.g. 0.05" required />
    </div>

    <div class="form-group">
      <label>Custom Tags (optional):</label>
      <div id="tags"></div>
      <button type="button" id="addTag" class="button-secondary">+ Add Tag</button>
    </div>

    <button id="dispatchBtn" type="submit">üöÄ Send Payment</button>
    <button id="disconnectBtn" type="button" class="button-secondary">üîí Disconnect</button>
  </form>

  <div class="result" id="result"></div>
  <button id="themeToggle" class="button-secondary" style="margin-top:20px;">üåì Toggle Theme</button>
</div>

<script type="module">
const arweave = Arweave.init({host:"arweave.net",port:443,protocol:"https"});
const walletStatus=document.getElementById("walletStatus");
const dispatchForm=document.getElementById("dispatchForm");
const resultDiv=document.getElementById("result");
const dispatchBtn=document.getElementById("dispatchBtn");
const disconnectBtn=document.getElementById("disconnectBtn");
const tagsContainer=document.getElementById("tags");
const addTagBtn=document.getElementById("addTag");
const themeToggle=document.getElementById("themeToggle");

let wallet,walletAddr,walletType=null;
const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const callbackUrl="https://marko-app.netlify.app/di";

// Theme persistence
const currentTheme=localStorage.getItem("theme")||"light";
document.documentElement.setAttribute("data-theme",currentTheme);
themeToggle.textContent=currentTheme==="dark"?"üåû Light Mode":"üåì Dark Mode";
themeToggle.onclick=()=>{
  const newTheme=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";
  document.documentElement.setAttribute("data-theme",newTheme);
  localStorage.setItem("theme",newTheme);
  themeToggle.textContent=newTheme==="dark"?"üåû Light Mode":"üåì Dark Mode";
};

// Tag management
addTagRow("App-Name","ArweavePaymentDispatcher");
addTagRow("Purpose","Payment");
addTagBtn.onclick=()=>addTagRow();
function addTagRow(name="",value=""){
  const row=document.createElement("div");
  row.className="tag-pair";
  row.innerHTML=`<input placeholder="Tag Name" value="${name}"><input placeholder="Tag Value" value="${value}">`;
  tagsContainer.appendChild(row);
}

// Wallet detection
window.addEventListener("DOMContentLoaded",async()=>{
  walletType=localStorage.getItem("walletType");
  if(walletType) walletType==="extension"?await reconnectExtension():await reconnectMobile();
  else await autoDetectWallet();
});

async function autoDetectWallet(){
  if(isMobile) await connectMobile();
  else if(window.arweaveWallet) await connectExtension();
  else await connectMobile();
}

async function connectExtension(){
  try{
    walletStatus.textContent="üîå Connecting to ArConnect/Wander...";
    await window.arweaveWallet.connect(["ACCESS_ADDRESS","SIGN_TRANSACTION"]);
    walletAddr=await window.arweaveWallet.getActiveAddress();
    walletType="extension";
    localStorage.setItem("walletType",walletType);
    showConnected(walletAddr);
  }catch(err){await connectMobile();}
}

async function reconnectExtension(){
  try{
    walletAddr=await window.arweaveWallet.getActiveAddress();
    if(walletAddr) showConnected(walletAddr);
    else throw new Error("No active session");
  }catch{await connectMobile();}
}

async function connectMobile(){
  try{
    walletStatus.textContent="üì± Connecting via arweave.app...";
    const webWallet=new window.ArweaveWebWallet({
      name:"Arweave Payment Dispatcher",
      logo:"https://github.com/IonTeLOS/marko-app/blob/b32d1cc9a37c1c91755051140874cd52cbd3beb4/appLogo_192.png?raw=true",
    });
    await webWallet.setUrl("arweave.app");
    await webWallet.connect({
      permissions:["ACCESS_ADDRESS","SIGN_TRANSACTION"],
      redirectUrl:callbackUrl,
    });
    wallet=webWallet;
    walletAddr=webWallet.address||"(unknown)";
    walletType="mobile";
    localStorage.setItem("walletType",walletType);
    showConnected(walletAddr);
  }catch(err){showError("Could not connect: "+err.message);}
}

async function reconnectMobile(){
  try{
    const webWallet=new window.ArweaveWebWallet({name:"Arweave Payment Dispatcher"});
    await webWallet.setUrl("arweave.app");
    wallet=webWallet;
    walletAddr=webWallet.address||"(unknown)";
    if(!walletAddr||walletAddr==("(unknown)")) throw new Error("Session expired");
    showConnected(walletAddr);
  }catch{await connectMobile();}
}

function showConnected(addr){
  walletStatus.classList.add("connected");
  walletStatus.textContent=`‚úÖ Connected: ${addr}`;
  dispatchForm.style.display="block";
}

// Dispatch (send payment)
dispatchForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const target=document.getElementById("target").value.trim();
  const amount=parseFloat(document.getElementById("amount").value.trim());
  if(!target||target.length<40) return showError("Invalid recipient address.");
  if(isNaN(amount)||amount<=0) return showError("Invalid amount.");

  const winston=arweave.ar.arToWinston(amount.toString());
  const tags={};
  document.querySelectorAll(".tag-pair").forEach(p=>{
    const k=p.children[0].value.trim(),v=p.children[1].value.trim();
    if(k&&v) tags[k]=v;
  });

  try{
    dispatchBtn.disabled=true;
    dispatchBtn.textContent="Sending...";
    const tx=await arweave.createTransaction({target,quantity:winston});
    for(const [k,v] of Object.entries(tags)) tx.addTag(k,v);
    let result;
    if(walletType==="extension")
      result=await window.arweaveWallet.sign(tx).then(()=>arweave.transactions.post(tx));
    else
      result=await wallet.sign(tx).then(()=>arweave.transactions.post(tx));
    showSuccess(tx.id);
  }catch(err){showError("Transaction failed: "+err.message);}
  finally{
    dispatchBtn.disabled=false;
    dispatchBtn.textContent="üöÄ Send Payment";
  }
});

disconnectBtn.onclick=async()=>{
  try{
    if(walletType==="mobile"&&wallet?.disconnect) await wallet.disconnect();
    if(walletType==="extension"&&window.arweaveWallet?.disconnect) await window.arweaveWallet.disconnect();
  }catch{}
  localStorage.removeItem("walletType");
  wallet=null;walletAddr=null;walletType=null;
  walletStatus.textContent="üëã Disconnected. Reloading...";
  setTimeout(()=>location.reload(),800);
};

function showSuccess(id){
  const url=`https://viewblock.io/arweave/tx/${id}`;
  resultDiv.className="result success";
  resultDiv.innerHTML=`
    <div class="result-title">‚úÖ Payment Sent!</div>
    <p><strong>ID:</strong> ${id}</p>
    <p><a href="${url}" target="_blank">View on ViewBlock ‚Üí</a></p>`;
  resultDiv.style.display="block";
}

function showError(msg){
  resultDiv.className="result error";
  resultDiv.innerHTML=`<div class="result-title">‚ùå Error</div><p>${msg}</p>`;
  resultDiv.style.display="block";
}
</script>
</body>
</html>

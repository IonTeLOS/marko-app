<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet History</title>
  <script src="https://unpkg.com/localforage/dist/localforage.min.js"></script>
  <script src="https://unpkg.com/arweave@1.15.5/bundles/web.bundle.js"></script>
  
  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --md-sys-color-primary: #6750A4;
      --md-sys-color-on-primary: #ffffff;
      --md-sys-color-surface: #FFFBFE;
      --md-sys-color-on-surface: #1C1B1F;
      --md-sys-color-surface-variant: #E7E0EC;
      --md-sys-color-outline: #79747E;
      --radius-lg: 28px;
      --radius-md: 18px;
      --radius-sm: 12px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --md-sys-color-primary: #D0BCFF;
        --md-sys-color-surface: #1C1B1F;
        --md-sys-color-on-surface: #E6E1E5;
        --md-sys-color-surface-variant: #49454F;
        --md-sys-color-outline: #938F99;
      }
    }

    body {
      font-family: "Roboto", system-ui, sans-serif;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      padding: 20px;
    }

    .material-symbols-rounded {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24;
      vertical-align: middle;
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 24px;
      background: var(--md-sys-color-surface-variant);
      padding: 24px;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-top {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .back-button {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-md);
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .back-button:hover {
      transform: scale(1.02);
      filter: brightness(1.1);
    }

    .header-title {
      font-size: 32px;
      font-weight: 700;
      flex: 1;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-input, .date-filter {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 1px solid var(--md-sys-color-outline);
      border-radius: var(--radius-md);
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      font-size: 14px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
    }

    .btn-danger {
      background: #B3261E;
      color: white;
    }

    .btn-secondary {
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      border: 1px solid var(--md-sys-color-outline);
    }

    .btn:hover {
      transform: scale(1.02);
      filter: brightness(1.1);
    }

    .tabs-container {
      max-width: 1200px;
      margin: 0 auto 24px;
      background: var(--md-sys-color-surface-variant);
      border-radius: var(--radius-lg);
      padding: 8px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .history-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--md-sys-color-on-surface);
      white-space: nowrap;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-tab:hover {
      background: rgba(103, 80, 164, 0.1);
    }

    .history-tab.active {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      font-weight: 600;
    }

    .history-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .sync-banner {
      max-width: 1200px;
      margin: 0 auto 16px;
      padding: 16px;
      background: rgba(100, 150, 255, 0.18);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sync-banner-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .event-card {
      background: white;
      padding: 20px;
      margin-bottom: 16px;
      border-radius: var(--radius-md);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }

    .event-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .event-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .event-icon {
      font-size: 32px;
    }

    .event-title {
      font-weight: 600;
      font-size: 16px;
      text-transform: capitalize;
    }

    .event-time {
      font-size: 12px;
      color: #666;
    }

    .event-details {
      margin-top: 12px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
    }

    .detail-label {
      color: #666;
      font-weight: 500;
    }

    .detail-value {
      font-weight: 600;
    }

    .event-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .action-btn {
      padding: 8px 16px;
      background: var(--md-sys-color-surface-variant);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      text-decoration: none;
      color: var(--md-sys-color-on-surface);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .action-btn:hover {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      transform: scale(1.05);
    }

    .context-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      border-radius: 6px;
      margin: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .context-menu-item:hover {
      background: rgba(103, 80, 164, 0.1);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .spinning {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <button class="back-button" onclick="goBackToWallet()">
        <span class="material-symbols-rounded">arrow_back</span>
        Back to Wallet
      </button>
      <h1 class="header-title">Wallet History</h1>
    </div>
    <div class="header-controls">
      <input
        type="text"
        id="history-search"
        class="search-input"
        placeholder="ðŸ” Search events..."
      />
      <select id="history-date-filter" class="date-filter">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
      <button class="btn btn-primary" onclick="HistoryUI.exportHistory()">
        <span class="material-symbols-rounded">download</span>
        Export
      </button>
      <button class="btn btn-danger" onclick="HistoryUI.clearAllConfirm()">
        <span class="material-symbols-rounded">delete</span>
        Clear All
      </button>
    </div>
  </div>

  <div id="sync-banner" class="sync-banner" style="display: none;">
    <div class="sync-banner-left">
      <span class="material-symbols-rounded spinning">sync</span>
      <span id="sync-status">Syncing transactions from Arweave...</span>
    </div>
    <button class="btn btn-secondary" onclick="HistoryUI.syncTransactions()">
      <span class="material-symbols-rounded">refresh</span>
      Sync Now
    </button>
  </div>

  <div class="tabs-container">
    <button class="history-tab active" data-type="all" onclick="switchHistoryTab('all')">
      <span class="material-symbols-rounded">view_list</span>
      All
    </button>
    <button class="history-tab" data-type="upload" onclick="switchHistoryTab('upload')">
      <span class="material-symbols-rounded">upload_file</span>
      Uploads
    </button>
    <button class="history-tab" data-type="transaction" onclick="switchHistoryTab('transaction')">
      <span class="material-symbols-rounded">currency_exchange</span>
      Transactions
    </button>
    <button class="history-tab" data-type="signature" onclick="switchHistoryTab('signature')">
      <span class="material-symbols-rounded">edit_note</span>
      Signatures
    </button>
    <button class="history-tab" data-type="system" onclick="switchHistoryTab('system')">
      <span class="material-symbols-rounded">settings</span>
      System
    </button>
    <button class="history-tab" data-type="error" onclick="switchHistoryTab('error')">
      <span class="material-symbols-rounded">error</span>
      Errors
    </button>
  </div>

  <div id="history-container" class="history-container">
    <div style="text-align: center; padding: 60px; color: #999;">
      Loading history...
    </div>
  </div>

  <script>
// ============================================================================
// ARWEAVE & CONFIG
// ============================================================================
const WALLET_APP_NAME = 'ArweaveWallet-v1';
let arweave = null;

try {
  if (window.Arweave) {
    arweave = Arweave.init({ host: 'arweave.net', port: 443, protocol: 'https' });
  }
} catch (e) {
  console.error('Failed to init Arweave:', e);
}

// ============================================================================
// WALLET ADDRESS RETRIEVAL
// ============================================================================
const WalletStorage = (function() {
  const prefix = 'biowallet:';
  const hasLocalforage = typeof window !== 'undefined' && window.localforage;

  async function get(key) {
    const full = prefix + key;
    return hasLocalforage ? await window.localforage.getItem(full) : localStorage.getItem(full);
  }

  return { get };
})();

async function getWalletAddress() {
  return await WalletStorage.get('address');
}

// ============================================================================
// UNIVERSAL WALLET HISTORY LOGGER - Vanilla JS Version
// ============================================================================

const HistoryLogger = {
  // Event type constants
  TYPES: {
    UPLOAD: 'upload',
    TRANSACTION: 'transaction',
    SIGNATURE: 'signature',
    SYSTEM: 'system',
    ERROR: 'error'
  },

  // Status constants
  STATUS: {
    SUCCESS: 'success',
    PENDING: 'pending',
    FAILED: 'failed'
  },

  async log(type, data, status = 'success') {
    const event = {
      id: this.generateId(),
      timestamp: Date.now(),
      type,
      status,
      data: { ...data }
    };

    const storageKey = `wallet-history:${type}`;
    let events = [];

    try {
      const stored = await localforage.getItem(storageKey);
      events = stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.warn('Failed to load existing events:', e);
    }

    events.unshift(event);

    if (events.length > 1000) {
      events = events.slice(0, 1000);
    }

    try {
      await localforage.setItem(storageKey, JSON.stringify(events));
    } catch (e) {
      console.error('Failed to save event:', e);
    }

    return event.id;
  },

  async logUpload({ txid, fileName, fileSize, contentType, encryptionMode, recipient, password, decryptLink }) {
    return this.log('upload', {
      txid,
      fileName: fileName || 'Untitled',
      fileSize,
      contentType,
      encryptionMode,
      recipient,
      hasPassword: !!password,
      decryptLink,
      arweaveLink: `https://marko-app.netlify.app/dw2/?link=https://arweave.net/${txid}`
    });
  },

  async logTransaction({ txid, direction, address, amount, sentViaWallet, status = 'pending' }) {
    return this.log('transaction', {
      txid,
      direction,
      address,
      amount,
      sentViaWallet,
      arweaveLink: `https://arweave.net/${txid}`,
      viewscanLink: `https://viewblock.io/arweave/tx/${txid}`
    }, status);
  },

  async logSignature({ message, signature, address, requestedBy, callbackUrl, isCAIP122, options }) {
    return this.log('signature', {
      message,
      signature,
      address,
      requestedBy,
      callbackUrl,
      isCAIP122,
      options
    });
  },

  async logSystem({ action, details, address }) {
    return this.log('system', {
      action,
      details,
      address
    });
  },

  async logError({ operation, error, details }) {
    return this.log('error', {
      operation,
      error: error.message || String(error),
      details
    }, 'failed');
  },

  async getEvents(type, limit = 100) {
    const storageKey = `wallet-history:${type}`;
    try {
      const stored = await localforage.getItem(storageKey);
      const events = stored ? JSON.parse(stored) : [];
      return events.slice(0, limit);
    } catch (e) {
      console.error('Failed to load events:', e);
      return [];
    }
  },

  async getAllEvents(limit = 100) {
    const types = Object.values(this.TYPES);
    const allEvents = [];

    for (const type of types) {
      const events = await this.getEvents(type, 1000);
      allEvents.push(...events);
    }

    allEvents.sort((a, b) => b.timestamp - a.timestamp);

    return allEvents.slice(0, limit);
  },

  async updateEventStatus(type, eventId, newStatus) {
    const storageKey = `wallet-history:${type}`;
    try {
      const stored = await localforage.getItem(storageKey);
      const events = stored ? JSON.parse(stored) : [];

      const event = events.find(e => e.id === eventId);
      if (event) {
        event.status = newStatus;
        event.updatedAt = Date.now();
        await localforage.setItem(storageKey, JSON.stringify(events));
      }
    } catch (e) {
      console.error('Failed to update event status:', e);
    }
  },

  async deleteEvent(type, eventId) {
    const storageKey = `wallet-history:${type}`;
    try {
      const stored = await localforage.getItem(storageKey);
      let events = stored ? JSON.parse(stored) : [];
      events = events.filter(e => e.id !== eventId);
      await localforage.setItem(storageKey, JSON.stringify(events));
      return true;
    } catch (e) {
      console.error('Failed to delete event:', e);
      return false;
    }
  },

  async clearType(type) {
    const storageKey = `wallet-history:${type}`;
    try {
      await localforage.removeItem(storageKey);
      return true;
    } catch (e) {
      console.error('Failed to clear type:', e);
      return false;
    }
  },

  async clearAll() {
    const types = Object.values(this.TYPES);
    for (const type of types) {
      await this.clearType(type);
    }
    return true;
  },

  async exportHistory() {
    const allEvents = await this.getAllEvents(10000);
    return JSON.stringify(allEvents, null, 2);
  },

  generateId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
};

// ============================================================================
// GRAPHQL TRANSACTION SYNC
// ============================================================================
async function syncTransactionsFromArweave() {
  const address = await getWalletAddress();
  if (!address || !arweave) {
    console.warn('Cannot sync: wallet address not found or Arweave not initialized');
    return { synced: 0, errors: [] };
  }

  const query = `{
    transactions(
      owners: ["${address}"],
      first: 50,
      sort: HEIGHT_DESC
    ) {
      edges {
        node {
          id
          recipient
          quantity { ar }
          block { timestamp }
          tags { name value }
        }
      }
    }
  }`;

  try {
    const response = await fetch('https://arweave.net/graphql', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });

    const result = await response.json();
    const txEdges = result.data?.transactions?.edges || [];

    // Get already logged transactions
    const loggedTxs = await HistoryLogger.getEvents('transaction', 1000);
    const loggedTxIds = new Set(loggedTxs.map(e => e.data.txid));

    let syncCount = 0;
    const errors = [];

    for (const edge of txEdges) {
      const tx = edge.node;
      const txid = tx.id;

      // Skip if already logged
      if (loggedTxIds.has(txid)) continue;

      try {
        const isReceived = tx.recipient && tx.recipient !== address;
        const direction = isReceived ? 'received' : 'sent';
        const status = tx.block ? 'success' : 'pending';

        await HistoryLogger.logTransaction({
          txid: txid,
          direction: direction,
          address: tx.recipient || address,
          amount: `${tx.quantity.ar} AR`,
          sentViaWallet: false, // External transaction
          status: status
        });

        syncCount++;
      } catch (err) {
        console.error(`Failed to log transaction ${txid}:`, err);
        errors.push({ txid, error: err.message });
      }
    }

    return { synced: syncCount, errors };
  } catch (error) {
    console.error('GraphQL sync failed:', error);
    return { synced: 0, errors: [{ error: error.message }] };
  }
}

// ============================================================================
// HISTORY PAGE UI - Material Design Styled
// ============================================================================

const HistoryUI = {
  currentTab: 'all',
  searchTerm: '',
  dateFilter: 'all',
  events: [],
  isSyncing: false,

  formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;

    return date.toLocaleString(undefined, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  },

  getEventIcon(type) {
    const icons = {
      upload: '<span class="material-symbols-rounded">upload_file</span>',
      transaction: '<span class="material-symbols-rounded">currency_exchange</span>',
      signature: '<span class="material-symbols-rounded">edit_note</span>',
      system: '<span class="material-symbols-rounded">settings</span>',
      error: '<span class="material-symbols-rounded">error</span>'
    };
    return icons[type] || '<span class="material-symbols-rounded">description</span>';
  },

  getStatusBadge(status) {
    const colors = {
      success: 'background: rgba(0, 200, 83, 0.18); color: #0d4d0d;',
      pending: 'background: rgba(255, 193, 7, 0.18); color: #7d5c00;',
      failed: 'background: rgba(255, 82, 82, 0.18); color: #7b0000;'
    };
    return `<span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${colors[status]}">${status}</span>`;
  },

  filterEvents(events) {
    let filtered = events;

    if (this.dateFilter !== 'all') {
      const now = Date.now();
      const ranges = {
        today: 86400000,
        week: 604800000,
        month: 2592000000
      };
      filtered = filtered.filter(e => now - e.timestamp < ranges[this.dateFilter]);
    }

    if (this.searchTerm) {
      const term = this.searchTerm.toLowerCase();
      filtered = filtered.filter(e =>
        JSON.stringify(e.data).toLowerCase().includes(term) ||
        e.type.toLowerCase().includes(term)
      );
    }

    return filtered;
  },

  async loadEvents() {
    if (this.currentTab === 'all') {
      this.events = await HistoryLogger.getAllEvents(500);
    } else {
      this.events = await HistoryLogger.getEvents(this.currentTab, 500);
    }
    this.render();
  },

  renderEventCard(event) {
    const typeColors = {
      error: 'background: rgba(255, 82, 82, 0.1); border-left: 4px solid #B3261E;',
      system: 'background: rgba(100, 150, 255, 0.1); border-left: 4px solid #6750A4;',
      signature: 'background: rgba(156, 39, 176, 0.1); border-left: 4px solid #9C27B0;',
      transaction: 'background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50;',
      upload: 'background: rgba(255, 152, 0, 0.1); border-left: 4px solid #FF9800;'
    };

    let detailsHTML = '';

    if (event.type === 'upload') {
      detailsHTML = `
        <div class="event-details">
          <div class="detail-row">
            <span class="detail-label">File:</span>
            <span class="detail-value">${event.data.fileName}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Size:</span>
            <span class="detail-value">${(event.data.fileSize / 1024).toFixed(2)} KB</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Encryption:</span>
            <span class="detail-value" style="text-transform: capitalize;">${event.data.encryptionMode}</span>
          </div>
          <div class="event-actions">
            ${event.data.decryptLink ? `<a href="${event.data.decryptLink}" target="_blank" class="action-btn"><span class="material-symbols-rounded">open_in_new</span> Open</a>` : ''}
            <button onclick="HistoryUI.copyToClipboard('${event.data.txid}')" class="action-btn"><span class="material-symbols-rounded">content_copy</span> Copy TX</button>
          </div>
        </div>
      `;
    } else if (event.type === 'transaction') {
      detailsHTML = `
        <div class="event-details">
          <div class="detail-row">
            <span class="detail-label">Direction:</span>
            <span class="detail-value" style="color: ${event.data.direction === 'sent' ? '#B3261E' : '#4CAF50'}; font-weight: 600;">
              ${event.data.direction === 'sent' ? 'â†‘ Sent' : 'â†“ Received'}
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Amount:</span>
            <span class="detail-value">${event.data.amount}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Address:</span>
            <span class="detail-value" style="font-family: monospace; font-size: 11px;">${event.data.address.slice(0, 20)}...</span>
          </div>
          ${event.data.sentViaWallet === false ? '<div style="font-size: 11px; color: #666; font-style: italic; margin-top: 4px;">External transaction (not sent via this wallet)</div>' : ''}
          <div class="event-actions">
            <a href="${event.data.viewscanLink}" target="_blank" class="action-btn"><span class="material-symbols-rounded">search</span> ViewBlock</a>
            <button onclick="HistoryUI.copyToClipboard('${event.data.txid}')" class="action-btn"><span class="material-symbols-rounded">content_copy</span> Copy TX</button>
          </div>
        </div>
      `;
    } else if (event.type === 'signature') {
      detailsHTML = `
        <div class="event-details">
          <div class="detail-row">
            <span class="detail-label">Requested by:</span>
            <span class="detail-value">${event.data.requestedBy}</span>
          </div>
          <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin: 8px 0; font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto;">
            ${event.data.message.slice(0, 200)}${event.data.message.length > 200 ? '...' : ''}
          </div>
          ${event.data.isCAIP122 ? '<div style="font-size: 11px; color: #6750A4;">âœ“ CAIP-122 compliant signature</div>' : ''}
          <div class="event-actions">
            <button onclick="HistoryUI.copyToClipboard('${event.data.signature}')" class="action-btn"><span class="material-symbols-rounded">content_copy</span> Copy Signature</button>
          </div>
        </div>
      `;
    } else if (event.type === 'system') {
      detailsHTML = `
        <div class="event-details">
          <div class="detail-row">
            <span class="detail-label">Action:</span>
            <span class="detail-value" style="text-transform: capitalize;">${event.data.action.replace(/_/g, ' ')}</span>
          </div>
          <div style="color: #666; margin-top: 4px;">${event.data.details}</div>
        </div>
      `;
    } else if (event.type === 'error') {
      detailsHTML = `
        <div class="event-details">
          <div class="detail-row">
            <span class="detail-label">Operation:</span>
            <span class="detail-value" style="text-transform: capitalize;">${event.data.operation.replace(/_/g, ' ')}</span>
          </div>
          <div style="background: rgba(255, 82, 82, 0.1); padding: 12px; border-radius: 8px; margin: 8px 0; color: #B3261E; font-size: 12px;">
            ${event.data.error}
          </div>
          ${event.data.details ? `<div style="color: #666; font-size: 12px;">${event.data.details}</div>` : ''}
        </div>
      `;
    }

    return `
      <div class="event-card" style="${typeColors[event.type]}" data-event-id="${event.id}" data-event-type="${event.type}">
        <div class="event-header">
          <div class="event-header-left">
            <span class="event-icon">${this.getEventIcon(event.type)}</span>
            <div>
              <div class="event-title">${event.type}</div>
              <div class="event-time">${this.formatTimestamp(event.timestamp)}</div>
            </div>
          </div>
          ${this.getStatusBadge(event.status)}
        </div>
        ${detailsHTML}
      </div>
    `;
  },

  render() {
    const container = document.getElementById('history-container');
    if (!container) return;

    const filteredEvents = this.filterEvents(this.events);

    const eventsHTML = filteredEvents.length === 0
      ? '<div style="text-align: center; padding: 60px; color: #999;"><span class="material-symbols-rounded" style="font-size: 48px; display: block; margin-bottom: 16px;">inbox</span>No events yet</div>'
      : filteredEvents.map(e => this.renderEventCard(e)).join('');

    container.innerHTML = eventsHTML;

    this.attachContextMenus();
  },

  attachContextMenus() {
    const cards = document.querySelectorAll('.event-card');
    cards.forEach(card => {
      card.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const eventId = card.dataset.eventId;
        const eventType = card.dataset.eventType;
        this.showContextMenu(e.clientX, e.clientY, eventId, eventType);
      });
    });

    const tabs = document.querySelectorAll('.history-tab');
    tabs.forEach(tab => {
      tab.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const tabType = tab.dataset.type;
        if (tabType !== 'all') {
          this.showTabContextMenu(e.clientX, e.clientY, tabType);
        }
      });
    });
  },

  showContextMenu(x, y, eventId, eventType) {
    this.removeContextMenu();

    const menu = document.createElement('div');
    menu.id = 'context-menu';
    menu.innerHTML = `
      <div class="context-menu-item" onclick="HistoryUI.deleteEventConfirm('${eventType}', '${eventId}')">
        <span class="material-symbols-rounded">delete</span>
        Delete this event
      </div>
    `;
    menu.style.cssText = `
      position: fixed;
      left: ${x}px;
      top: ${y}px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      min-width: 180px;
    `;
    document.body.appendChild(menu);

    setTimeout(() => {
      document.addEventListener('click', () => this.removeContextMenu(), { once: true });
    }, 100);
  },

  showTabContextMenu(x, y, tabType) {
    this.removeContextMenu();

    const menu = document.createElement('div');
    menu.id = 'context-menu';
    menu.innerHTML = `
      <div class="context-menu-item" onclick="HistoryUI.clearTabConfirm('${tabType}')">
        <span class="material-symbols-rounded">delete_sweep</span>
        Clear all ${tabType} events
      </div>
    `;
    menu.style.cssText = `
      position: fixed;
      left: ${x}px;
      top: ${y}px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      min-width: 200px;
    `;
    document.body.appendChild(menu);

    setTimeout(() => {
      document.addEventListener('click', () => this.removeContextMenu(), { once: true });
    }, 100);
  },

  removeContextMenu() {
    const existing = document.getElementById('context-menu');
    if (existing) existing.remove();
  },

  async deleteEventConfirm(eventType, eventId) {
    this.removeContextMenu();
    if (confirm('Delete this event from history?')) {
      await HistoryLogger.deleteEvent(eventType, eventId);
      await this.loadEvents();
    }
  },

  async clearTabConfirm(tabType) {
    this.removeContextMenu();
    if (confirm(`Clear all ${tabType} events? This cannot be undone.`)) {
      await HistoryLogger.clearType(tabType);
      await this.loadEvents();
    }
  },

  async clearAllConfirm() {
    if (confirm('âš ï¸ Delete ALL history across all categories? This cannot be undone!')) {
      await HistoryLogger.clearAll();
      await this.loadEvents();
    }
  },

  async exportHistory() {
    const json = await HistoryLogger.exportHistory();
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wallet-history-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  },

  copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      const toast = document.createElement('div');
      toast.innerHTML = '<span class="material-symbols-rounded" style="margin-right: 8px;">check_circle</span>Copied!';
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        animation: fadeIn 0.2s, fadeOut 0.2s 1.8s;
        display: flex;
        align-items: center;
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    });
  },

  async syncTransactions() {
    if (this.isSyncing) return;

    this.isSyncing = true;
    const banner = document.getElementById('sync-banner');
    const statusEl = document.getElementById('sync-status');
    
    banner.style.display = 'flex';
    statusEl.textContent = 'Syncing transactions from Arweave...';

    try {
      const result = await syncTransactionsFromArweave();
      
      if (result.synced > 0) {
        statusEl.textContent = `âœ… Synced ${result.synced} new transaction(s)`;
        await this.loadEvents();
      } else {
        statusEl.textContent = 'âœ… All transactions up to date';
      }

      if (result.errors.length > 0) {
        console.error('Sync errors:', result.errors);
      }

      setTimeout(() => {
        banner.style.display = 'none';
      }, 3000);

    } catch (error) {
      console.error('Sync failed:', error);
      statusEl.textContent = 'âŒ Sync failed. Click to retry.';
    } finally {
      this.isSyncing = false;
    }
  },

  async init() {
    // Check if we should show sync banner for transaction tab
    const address = await getWalletAddress();
    if (address) {
      // Auto-sync on first load if on transaction tab
      if (this.currentTab === 'transaction' || this.currentTab === 'all') {
        setTimeout(() => this.syncTransactions(), 1000);
      }
    }

    this.loadEvents();

    const searchInput = document.getElementById('history-search');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        this.searchTerm = e.target.value;
        this.render();
      });
    }

    const dateFilter = document.getElementById('history-date-filter');
    if (dateFilter) {
      dateFilter.addEventListener('change', (e) => {
        this.dateFilter = e.target.value;
        this.render();
      });
    }
  }
};

// ============================================================================
// TAB SWITCHING & NAVIGATION
// ============================================================================

function switchHistoryTab(tabType) {
  HistoryUI.currentTab = tabType;

  document.querySelectorAll('.history-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`.history-tab[data-type="${tabType}"]`).classList.add('active');

  HistoryUI.loadEvents();

  // Show sync banner if switching to transaction tab
  if (tabType === 'transaction' || tabType === 'all') {
    const banner = document.getElementById('sync-banner');
    banner.style.display = 'flex';
    document.getElementById('sync-status').textContent = 'Click "Sync Now" to fetch latest transactions';
  } else {
    document.getElementById('sync-banner').style.display = 'none';
  }
}

function goBackToWallet() {
  // Try to go back if history exists, otherwise navigate to wallet
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = 'w2.html'; // Adjust to your wallet filename
  }
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  HistoryUI.init();
});
  </script>
</body>
</html>

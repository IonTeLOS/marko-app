<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galene Stream</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }

        #status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1000;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        #status.loading {
            border: 2px solid #fbbf24;
        }

        #status.ready {
            border: 2px solid #10b981;
        }

        #status.error {
            border: 2px solid #ef4444;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #stream-container {
            width: 100vw;
            height: 100vh;
            display: none;
        }

        #stream-container.visible {
            display: block;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #error-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            text-align: center;
            border: 2px solid #ef4444;
        }

        #error-message.visible {
            display: block;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div id="status" class="loading">
        <span class="spinner"></span>
        <span id="status-text">Initializing service worker...</span>
    </div>

    <div id="stream-container">
        <iframe id="stream-frame" src=""></iframe>
    </div>

    <div id="error-message">
        <h2>⚠️ Unable to Load Stream</h2>
        <p id="error-text"></p>
        <button onclick="location.reload()">Retry</button>
        <button onclick="openDirect()">Open Direct Link</button>
    </div>

    <script>
        const STREAM_URL = 'https://kqrca-188-4-77-161.a.free.pinggy.link/group/tests/';
        const STATUS_TIMEOUT = 15000; // 15 seconds

        let timeoutId;

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            const statusText = document.getElementById('status-text');

            statusEl.className = type;
            statusText.textContent = message;

            if (type === 'ready') {
                setTimeout(() => {
                    statusEl.style.opacity = '0';
                    statusEl.style.transition = 'opacity 0.5s';
                    setTimeout(() => statusEl.style.display = 'none', 500);
                }, 2000);
            }
        }

        function showError(message) {
            updateStatus('Error', 'error');
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.add('visible');
        }

        function openDirect() {
            window.open(STREAM_URL, '_blank');
        }

        async function initServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                showError('Service Workers are not supported in this browser. Please use a modern browser like Chrome, Firefox, or Edge.');
                return;
            }

            try {
                // Create service worker inline
                const swCode = `
                    self.addEventListener('fetch', function(event) {
                        const url = event.request.url;

                        // Only intercept Pinggy requests
                        if (url.includes('pinggy.link') || url.includes('pinggy.io')) {
                            const modifiedRequest = new Request(event.request, {
                                headers: new Headers({
                                    'User-Agent': 'GaleneCustomViewer/1.0'
                                })
                            });

                            event.respondWith(
                                fetch(modifiedRequest)
                                    .catch(err => {
                                        console.error('Fetch failed:', err);
                                        return fetch(event.request);
                                    })
                            );
                        }
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(clients.claim());
                    });
                `;

                // Create blob URL for service worker
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                updateStatus('Registering service worker...', 'loading');

                const registration = await navigator.serviceWorker.register(swUrl);

                updateStatus('Waiting for service worker to activate...', 'loading');

                // Wait for service worker to be ready
                await navigator.serviceWorker.ready;

                // Ensure service worker is controlling this page
                if (!navigator.serviceWorker.controller) {
                    updateStatus('Reloading to activate service worker...', 'loading');
                    window.location.reload();
                    return;
                }

                updateStatus('Loading stream...', 'loading');

                // Set timeout for loading
                timeoutId = setTimeout(() => {
                    showError('Stream took too long to load. The Pinggy warning page might still be appearing. Try the direct link.');
                }, STATUS_TIMEOUT);

                // Load iframe
                const iframe = document.getElementById('stream-frame');
                const container = document.getElementById('stream-container');

                iframe.onload = () => {
                    clearTimeout(timeoutId);
                    updateStatus('Stream ready!', 'ready');
                    container.classList.add('visible');
                };

                iframe.onerror = () => {
                    clearTimeout(timeoutId);
                    showError('Failed to load stream. Please check your connection and try again.');
                };

                iframe.src = STREAM_URL;

            } catch (error) {
                console.error('Service worker registration failed:', error);
                showError(`Service worker failed: ${error.message}. The stream might still show a warning page.`);
            }
        }

        // Start initialization
        initServiceWorker();
    </script>
</body>
</html>

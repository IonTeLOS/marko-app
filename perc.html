<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dual-Provider Chat (OpenRouter / AIMLAPI)</title>
  <style>
    :root { color-scheme: light dark; --primary: #007bff; }
    body { font-family: ui-sans-serif, system-ui, sans-serif; margin: 0; line-height: 1.5; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
    .card { border: 1px solid rgba(127,127,127,.2); border-radius: 12px; padding: 16px; margin-bottom: 16px; background: rgba(127,127,127,0.03); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .grow { flex: 1; min-width: 200px; }
    label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; opacity: 0.8; }
    input, select, textarea, button { 
      width: 100%; box-sizing: border-box; border-radius: 8px; 
      border: 1px solid rgba(127,127,127,0.4); padding: 10px; font-size: 14px; background: canvas;
    }
    button { cursor: pointer; background: var(--primary); color: white; border: none; font-weight: 600; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.secondary { background: rgba(127,127,127,0.2); color: inherit; }
    .chat-box { height: 450px; overflow-y: auto; border: 1px solid rgba(127,127,127,.2); border-radius: 8px; padding: 12px; background: canvas; margin-bottom: 12px; }
    .msg { margin-bottom: 12px; }
    .msg.user { text-align: right; }
    .msg.user .bubble { background: var(--primary); color: white; display: inline-block; }
    .bubble { padding: 8px 12px; border-radius: 12px; max-width: 85%; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .msg.assistant .bubble { background: rgba(127,127,127,0.1); border: 1px solid rgba(127,127,127,0.1); }
    .status { font-size: 12px; opacity: 0.7; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="wrap">
  <h3>AI Collaboration Hub</h3>

  <div class="card">
    <div class="row">
      <div class="grow">
        <label>Provider</label>
        <select id="provider">
          <option value="openrouter">OpenRouter</option>
          <option value="aimlapi">AIMLAPI</option>
        </select>
      </div>
      <div class="grow">
        <label>Current Model</label>
        <input id="model" placeholder="e.g. google/gemini-2.0-flash-001" />
      </div>
      <div style="width: 120px;">
        <label>Stream</label>
        <select id="useStream">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="grow">
        <label id="keyLabel">OpenRouter API Key</label>
        <input id="apiKey" type="password" placeholder="sk-or-..." />
      </div>
      <div class="grow">
        <label>System Instructions</label>
        <input id="system" placeholder="You are a helpful assistant." />
      </div>
    </div>
    
    <div class="row" style="margin-bottom: 0;">
      <button class="secondary grow" id="clearBtn">Clear Chat</button>
      <button class="secondary grow" id="saveBtn">Save Settings</button>
    </div>
  </div>

  <div class="chat-box" id="chatBox"></div>
  
  <div class="row">
    <div class="grow" style="flex: 4;">
      <textarea id="userInput" placeholder="Type your message... (Enter to send)" rows="3"></textarea>
    </div>
    <div class="grow" style="display: flex; flex-direction: column; gap: 8px;">
      <button id="sendBtn" style="height: 100%;">Send</button>
      <button id="stopBtn" class="secondary" disabled>Stop</button>
    </div>
  </div>
  
  <div class="status" id="status">Status: Ready</div>
</div>

<script>
  const CONFIG = {
    openrouter: {
      url: "https://openrouter.ai/api/v1/chat/completions",
      key_ls: "key_openrouter",
      model_ls: "model_openrouter",
      label: "OpenRouter API Key"
    },
    aimlapi: {
      url: "https://api.aimlapi.com/v1/chat/completions",
      key_ls: "key_aimlapi",
      model_ls: "model_aimlapi",
      label: "AIMLAPI Key"
    }
  };

  let history = [];
  let abortController = null;

  const el = id => document.getElementById(id);
  const chatBox = el('chatBox');
  const providerSel = el('provider');
  const apiKeyInp = el('apiKey');
  const modelInp = el('model');
  const statusEl = el('status');

  // Initialization & Storage
  function loadSettings() {
    const p = providerSel.value;
    apiKeyInp.value = localStorage.getItem(CONFIG[p].key_ls) || "";
    modelInp.value = localStorage.getItem(CONFIG[p].model_ls) || (p === 'openrouter' ? "google/gemini-2.0-flash-001" : "gpt-4o");
    el('keyLabel').textContent = CONFIG[p].label;
  }

  function saveSettings() {
    const p = providerSel.value;
    localStorage.setItem(CONFIG[p].key_ls, apiKeyInp.value);
    localStorage.setItem(CONFIG[p].model_ls, modelInp.value);
    statusEl.textContent = "Status: Settings Saved Locally";
  }

  providerSel.onchange = loadSettings;
  el('saveBtn').onclick = saveSettings;
  el('clearBtn').onclick = () => { history = []; chatBox.innerHTML = ''; };

  // UI Helpers
  function appendMessage(role, text) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    div.appendChild(bubble);
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    return bubble;
  }

  async function handleSend() {
    const text = el('userInput').value.trim();
    if (!text || abortController) return;

    const p = providerSel.value;
    const key = apiKeyInp.value;
    const model = modelInp.value;
    const stream = el('useStream').value === "true";

    if (!key) return alert("Please enter an API Key");

    el('userInput').value = "";
    appendMessage('user', text);
    const assistantBubble = appendMessage('assistant', "...");
    
    statusEl.textContent = "Status: Connecting...";
    abortController = new AbortController();
    el('stopBtn').disabled = false;
    el('sendBtn').disabled = true;

    // Prepare Messages
    const messages = [];
    if (el('system').value) messages.push({ role: 'system', content: el('system').value });
    history.forEach(m => messages.push(m));
    messages.push({ role: 'user', content: text });

    try {
      const response = await fetch(CONFIG[p].url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${key}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': window.location.origin, // Required by some OpenRouter models
        },
        body: JSON.stringify({ model, messages, stream }),
        signal: abortController.signal
      });

      if (!response.ok) throw new Error(await response.text());

      let fullContent = "";
      assistantBubble.textContent = "";

      if (stream) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split("\n");
          buffer = lines.pop(); 

          for (const line of lines) {
            const cleanLine = line.trim().replace(/^data: /, "");
            if (!cleanLine || cleanLine === "[DONE]") continue;

            try {
              const json = JSON.parse(cleanLine);
              const delta = json.choices[0]?.delta?.content || "";
              fullContent += delta;
              assistantBubble.textContent = fullContent;
              chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) {}
          }
        }
      } else {
        const data = await response.json();
        fullContent = data.choices[0].message.content;
        assistantBubble.textContent = fullContent;
      }

      history.push({ role: 'user', content: text });
      history.push({ role: 'assistant', content: fullContent });
      statusEl.textContent = "Status: Done";

    } catch (err) {
      if (err.name === 'AbortError') {
        statusEl.textContent = "Status: Stopped by user";
      } else {
        assistantBubble.textContent = "Error: " + err.message;
        statusEl.textContent = "Status: Error occurred";
      }
    } finally {
      abortController = null;
      el('stopBtn').disabled = true;
      el('sendBtn').disabled = false;
    }
  }

  el('sendBtn').onclick = handleSend;
  el('stopBtn').onclick = () => abortController?.abort();
  el('userInput').onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };

  loadSettings();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thyra - Secure File & Message Storage</title>
  <meta name="description" content="Upload and share files and messages securely on Arweave with end-to-end encryption">

  <!-- Material Design Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --primary-light: #42a5f5;
      --secondary: #dc004e;
      --surface: #ffffff;
      --background: #f5f5f5;
      --on-surface: #1d1d1d;
      --on-primary: #ffffff;
      --border: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--background);
      color: var(--on-surface);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
      padding-top: 24px;
    }

    .logo {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }

    .subtitle {
      color: #666;
      font-size: 0.9rem;
      font-weight: 400;
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 2px 16px var(--shadow);
      margin-bottom: 24px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
    }

    .card-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-header .material-icons {
      color: var(--primary);
      font-size: 24px;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--on-surface);
    }

    .card-content {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--on-surface);
      margin-bottom: 8px;
    }

    .input-container {
      position: relative;
    }

    .input, .textarea {
      width: 100%;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      background: var(--surface);
      color: var(--on-surface);
      transition: all 0.3s ease;
    }

    .input:focus, .textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(25, 118, 210, 0.1);
    }

    .textarea {
      resize: vertical;
      min-height: 100px;
    }

    .file-input {
      display: none;
    }

    .file-drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 32px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--surface);
    }

    .file-drop-zone:hover, .file-drop-zone.drag-over {
      border-color: var(--primary);
      background: rgba(25, 118, 210, 0.05);
    }

    .file-drop-zone .material-icons {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: 16px;
      opacity: 0.7;
    }

    .file-drop-text {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .file-drop-hint {
      color: #999;
      font-size: 0.8rem;
    }

    .file-selected {
      background: rgba(76, 175, 80, 0.1);
      border-color: var(--success);
      padding: 16px;
      border-radius: 12px;
      margin-top: 16px;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .file-info .material-icons {
      color: var(--success);
    }

    .file-details {
      flex: 1;
    }

    .file-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .file-size {
      color: #666;
      font-size: 0.8rem;
    }

    .btn {
      background: var(--primary);
      color: var(--on-primary);
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      text-decoration: none;
    }

    .btn:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--primary);
      color: var(--on-primary);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.875rem;
      width: auto;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-row .btn {
      flex: 1;
      min-width: 120px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 24px;
      color: #666;
    }

    .loading.show {
      display: block;
    }

    .loading .material-icons {
      animation: spin 1s linear infinite;
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 8px;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .result {
      display: none;
      padding: 20px;
      border-radius: 12px;
      margin-top: 16px;
    }

    .result.show {
      display: block;
    }

    .result.success {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .result.error {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .result-title {
      font-weight: 500;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-content {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .result-url {
      background: rgba(25, 118, 210, 0.1);
      border: 1px solid rgba(25, 118, 210, 0.3);
      padding: 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
      margin: 16px 0;
      color: var(--primary);
      font-weight: 500;
    }

    .result-url a {
      color: var(--primary) !important;
      text-decoration: none !important;
      display: block;
      padding: 4px 0;
    }

    .result-url a:hover {
      text-decoration: underline !important;
    }

    .instructions {
      background: rgba(25, 118, 210, 0.05);
      border: 1px solid rgba(25, 118, 210, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      font-size: 0.9rem;
      color: #333;
    }

    .instructions .material-icons {
      color: var(--primary);
      font-size: 20px;
      vertical-align: middle;
      margin-right: 8px;
    }

    .footer {
      text-align: center;
      padding: 24px 0;
      color: #666;
      font-size: 0.8rem;
      border-top: 1px solid var(--border);
      margin-top: 32px;
    }

    .clear-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .clear-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #666;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .checkbox-label {
      font-size: 0.9rem;
      color: #666;
      cursor: pointer;
    }

    .copy-btn {
      background: rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.2);
      color: #333;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .copy-btn:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .history-item {
      background: rgba(0, 0, 0, 0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .history-item:hover {
      background: rgba(0, 0, 0, 0.05);
      border-color: var(--primary);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-number {
      background: var(--primary);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .history-timestamp {
      color: #666;
      font-size: 0.8rem;
    }

    .history-content {
      margin: 8px 0;
    }

    .history-title {
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--on-surface);
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-title:hover {
      color: var(--primary);
    }

    .history-note {
      color: #666;
      font-size: 0.8rem;
      font-style: italic;
      margin-bottom: 8px;
    }

    .history-url {
      font-family: monospace;
      font-size: 0.7rem;
      color: var(--primary);
      word-break: break-all;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .history-actions {
      display: flex;
      gap: 8px;
    }

    .history-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--on-surface);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .history-btn.delete {
      color: var(--error);
      border-color: var(--error);
    }

    .history-btn.delete:hover {
      background: var(--error);
      color: white;
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }

      .card-content {
        padding: 20px;
      }

      .btn-row {
        flex-direction: column;
      }

      .btn-row .btn {
        width: 100%;
      }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="logo">Thyra</h1>
      <p class="subtitle">Secure file & message storage on Arweave</p>
    </div>

    <!-- Instructions -->
    <div class="instructions">
      <span class="material-icons">info</span>
      Upload messages or files with automatic encryption. Share URLs to access content from anywhere.
    </div>

    <!-- Message Upload -->
    <div class="card fade-in">
      <div class="card-header">
        <span class="material-icons">message</span>
        <h2 class="card-title">Send Message</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label class="label" for="message-input">Your message</label>
          <div class="input-container">
            <textarea
              class="textarea"
              id="message-input"
              placeholder="Type your message here..."
              maxlength="50000"
            ></textarea>
            <button class="clear-btn" id="clear-message-btn" type="button" style="display: none;">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="unencrypted-message" class="checkbox">
          <label for="unencrypted-message" class="checkbox-label">Upload without encryption</label>
        </div>
<!-- For Message Upload section -->
<div class="checkbox-group">
  <input type="checkbox" id="password-protected-message" class="checkbox">
  <label for="password-protected-message" class="checkbox-label">Password protected (pre-shared key)</label>
</div>

<div class="form-group" id="message-password-group" style="display: none;">
  <label class="label" for="message-password">Pre-shared password</label>
  <div class="input-container">
    <input
      type="password"
      class="input"
      id="message-password"
      placeholder="Enter pre-shared password..."
      maxlength="200"
    >
    <button class="clear-btn" id="clear-message-password-btn" type="button" style="display: none;">
      <span class="material-icons">close</span>
    </button>
  </div>
  <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
    Share this password with your recipient separately. The URL will not contain the decryption key.
  </div>
</div>

        <div class="form-group">
          <label class="label" for="message-note">Note (optional)</label>
          <div class="input-container">
            <input
              type="text"
              class="input"
              id="message-note"
              placeholder="Add a note..."
              maxlength="100"
            >
            <button class="clear-btn" id="clear-message-note-btn" type="button" style="display: none;">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>

        <button class="btn" id="upload-message-btn" disabled>
          <span class="material-icons">send</span>
          Upload Message
        </button>

        <div class="loading" id="message-loading">
          <span class="material-icons">refresh</span>
          <div>Uploading to Arweave...</div>
        </div>

        <div class="result" id="message-result"></div>
      </div>
    </div>

    <!-- File Upload -->
    <div class="card fade-in">
      <div class="card-header">
        <span class="material-icons">upload_file</span>
        <h2 class="card-title">Upload File</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label class="label">Select or drop file</label>
          <input type="file" class="file-input" id="file-input">
          <div class="file-drop-zone" id="file-drop-zone">
            <span class="material-icons">cloud_upload</span>
            <div class="file-drop-text">Click to select or drag & drop</div>
            <div class="file-drop-hint">Max 95KB per file</div>
          </div>
          <div class="file-selected" id="file-selected" style="display: none;">
            <div class="file-info">
              <span class="material-icons">description</span>
              <div class="file-details">
                <div class="file-name" id="file-name"></div>
                <div class="file-size" id="file-size"></div>
              </div>
              <button class="btn btn-secondary btn-small" id="clear-file-btn">
                <span class="material-icons">close</span>
                Remove
              </button>
            </div>
          </div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="unencrypted-file" class="checkbox">
          <label for="unencrypted-file" class="checkbox-label">Upload without encryption</label>
        </div>
<!-- For File Upload section -->
<div class="checkbox-group">
  <input type="checkbox" id="password-protected-file" class="checkbox">
  <label for="password-protected-file" class="checkbox-label">Password protected (pre-shared key)</label>
</div>

<div class="form-group" id="file-password-group" style="display: none;">
  <label class="label" for="file-password">Pre-shared password</label>
  <div class="input-container">
    <input
      type="password"
      class="input"
      id="file-password"
      placeholder="Enter pre-shared password..."
      maxlength="200"
    >
    <button class="clear-btn" id="clear-file-password-btn" type="button" style="display: none;">
      <span class="material-icons">close</span>
    </button>
  </div>
  <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
    Share this password with your recipient separately. The URL will not contain the decryption key.
  </div>
</div>
        <div class="form-group">
          <label class="label" for="file-note">Note (optional)</label>
          <div class="input-container">
            <input
              type="text"
              class="input"
              id="file-note"
              placeholder="Add a note..."
              maxlength="100"
            >
            <button class="clear-btn" id="clear-file-note-btn" type="button" style="display: none;">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>

        <button class="btn" id="upload-file-btn" disabled>
          <span class="material-icons">upload</span>
          Upload File
        </button>

        <div class="loading" id="file-loading">
          <span class="material-icons">refresh</span>
          <div>Uploading to Arweave...</div>
        </div>

        <div class="result" id="file-result"></div>
      </div>
    </div>

    <!-- Share URL Access -->
    <div class="card fade-in">
      <div class="card-header">
        <span class="material-icons">link</span>
        <h2 class="card-title">Access Shared Content</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label class="label" for="share-url-input">Paste share URL</label>
          <div class="input-container">
            <input
              type="text"
              class="input"
              id="share-url-input"
              placeholder="https://example.com/s/?url=..."
            >
            <button class="clear-btn" id="clear-share-url-btn" type="button" style="display: none;">
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>

        <button class="btn btn-secondary" id="open-share-url-btn" disabled>
          <span class="material-icons">open_in_new</span>
          Open Content
        </button>
      </div>
    </div>

    <!-- History Section -->
    <div class="card fade-in">
      <div class="card-header">
        <span class="material-icons">history</span>
        <h2 class="card-title">Upload History</h2>
      </div>
      <div class="card-content">
        <button class="btn btn-secondary" id="toggle-history-btn">
          <span class="material-icons">visibility</span>
          Show History
        </button>

        <div id="history-section" style="display: none; margin-top: 16px;">
          <div id="history-list"></div>
          <button class="btn btn-secondary btn-small" id="clear-all-history-btn" style="margin-top: 16px;">
            <span class="material-icons">delete_sweep</span>
            Clear All History
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      Powered by Arweave • Data stored permanently • End-to-end encrypted
    </div>
  </div>

<script>
const API_BASE = 'https://marko-app.netlify.app/.netlify/functions/arload';

// DOM elements
const messageInput = document.getElementById('message-input');
const messageNote = document.getElementById('message-note');
const unencryptedMessage = document.getElementById('unencrypted-message');
const uploadMessageBtn = document.getElementById('upload-message-btn');
const messageLoading = document.getElementById('message-loading');
const messageResult = document.getElementById('message-result');
const clearMessageBtn = document.getElementById('clear-message-btn');
const clearMessageNoteBtn = document.getElementById('clear-message-note-btn');

const fileInput = document.getElementById('file-input');
const fileDropZone = document.getElementById('file-drop-zone');
const fileSelected = document.getElementById('file-selected');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const fileNote = document.getElementById('file-note');
const unencryptedFile = document.getElementById('unencrypted-file');
const uploadFileBtn = document.getElementById('upload-file-btn');
const clearFileBtn = document.getElementById('clear-file-btn');
const clearFileNoteBtn = document.getElementById('clear-file-note-btn');
const fileLoading = document.getElementById('file-loading');
const fileResult = document.getElementById('file-result');

const shareUrlInput = document.getElementById('share-url-input');
const openShareUrlBtn = document.getElementById('open-share-url-btn');
const clearShareUrlBtn = document.getElementById('clear-share-url-btn');

const toggleHistoryBtn = document.getElementById('toggle-history-btn');
const historySection = document.getElementById('history-section');
const historyList = document.getElementById('history-list');
const clearAllHistoryBtn = document.getElementById('clear-all-history-btn');

// Add these to the existing DOM elements
const passwordProtectedMessage = document.getElementById('password-protected-message');
const messagePassword = document.getElementById('message-password');
const messagePasswordGroup = document.getElementById('message-password-group');
const clearMessagePasswordBtn = document.getElementById('clear-message-password-btn');

const passwordProtectedFile = document.getElementById('password-protected-file');
const filePassword = document.getElementById('file-password');
const filePasswordGroup = document.getElementById('file-password-group');
const clearFilePasswordBtn = document.getElementById('clear-file-password-btn');

let selectedFile = null;
let uploadHistory = JSON.parse(localStorage.getItem('thyra_upload_history') || '[]');
let historyVisible = false;


// PBKDF2 key derivation function
async function deriveKeyFromPassword(password) {
 try {
   const encoder = new TextEncoder();
   const passwordData = encoder.encode(password);

   const keyMaterial = await crypto.subtle.importKey(
     'raw',
     passwordData,
     'PBKDF2',
     false,
     ['deriveBits']
   );

   const saltData = encoder.encode('thyra-salt-v1-2025');

   const derivedBits = await crypto.subtle.deriveBits(
     {
       name: 'PBKDF2',
       salt: saltData,
       iterations: 100000,
       hash: 'SHA-256'
     },
     keyMaterial,
     256 // 256 bits = 32 bytes
   );

   const keyArray = new Uint8Array(derivedBits);
   const base64Key = btoa(String.fromCharCode(...keyArray));

   return base64Key;
 } catch (error) {
   console.error('Key derivation failed:', error);
   throw new Error(`Key derivation failed: ${error.message}`);
 }
}

// URL parameter handling function
// Update the handlePasswordParameter function
async function handlePasswordParameter() {
  const urlParams = new URLSearchParams(window.location.search);
  const pass = urlParams.get('pass');
  const url = urlParams.get('url');

  if (pass && url) {
    try {
      // Derive key from password
      const derivedKey = await deriveKeyFromPassword(pass);

      // Create new URL with key instead of pass
      const newUrl = `${window.location.origin}${window.location.pathname}?url=${url}&key=${encodeURIComponent(derivedKey)}`;

      // Redirect to the new URL
      window.location.href = newUrl;
    } catch (error) {
      console.error('Failed to process password parameter:', error);
      alert('Failed to process password. Please try again.');
    }
  }
}

// Add new function to handle share URL input with password
async function handleShareUrlWithPassword(inputUrl) {
  try {
    const urlObj = new URL(inputUrl);
    const pass = urlObj.searchParams.get('pass');
    const url = urlObj.searchParams.get('url');

    if (pass && url) {
      // Derive key from password
      const derivedKey = await deriveKeyFromPassword(pass);

      // Create new URL with key instead of pass
      const newUrl = `${urlObj.origin}${urlObj.pathname}?url=${url}&key=${encodeURIComponent(derivedKey)}`;

      return newUrl;
    }
  } catch (error) {
    console.error('Failed to process share URL with password:', error);
    throw error;
  }

  return inputUrl; // Return original if no password parameter found
}

// Update the openShareUrl function
async function openShareUrl() {
  const url = shareUrlInput.value.trim();
  if (url) {
    try {
      // Check if URL contains password parameter and convert it
      const processedUrl = await handleShareUrlWithPassword(url);
      window.open(processedUrl, '_blank');
    } catch (error) {
      console.error('Failed to process share URL:', error);
      alert('Failed to process share URL. Please check the URL and try again.');
    }
  }
}

// Helper functions
function toggleClearButton(btn, hasValue) {
 if (btn) btn.style.display = hasValue ? 'block' : 'none';
}

function updateButtonStates() {
 const hasMessage = messageInput.value.trim().length > 0;
 const hasFile = selectedFile !== null;
 const hasShareUrl = shareUrlInput.value.trim().length > 0;

 uploadMessageBtn.disabled = !hasMessage;
 uploadFileBtn.disabled = !hasFile;
 openShareUrlBtn.disabled = !hasShareUrl;
}

function initializeEventListeners() {
 // Message input events
 messageInput.addEventListener('input', () => {
   updateButtonStates();
   toggleClearButton(clearMessageBtn, messageInput.value.trim());
   // Auto-resize textarea
   messageInput.style.height = 'auto';
   messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
 });

 messageNote.addEventListener('input', () => {
   updateButtonStates();
   toggleClearButton(clearMessageNoteBtn, messageNote.value.trim());
 });

 clearMessageBtn.addEventListener('click', clearMessage);
 clearMessageNoteBtn.addEventListener('click', () => {
   messageNote.value = '';
   toggleClearButton(clearMessageNoteBtn, false);
   updateButtonStates();
 });
 uploadMessageBtn.addEventListener('click', uploadMessage);

 // File input events
 fileInput.addEventListener('change', handleFileSelect);
 fileDropZone.addEventListener('click', () => fileInput.click());
 fileDropZone.addEventListener('dragover', handleDragOver);
 fileDropZone.addEventListener('dragleave', handleDragLeave);
 fileDropZone.addEventListener('drop', handleFileDrop);
 fileNote.addEventListener('input', () => {
   updateButtonStates();
   toggleClearButton(clearFileNoteBtn, fileNote.value.trim());
 });
 clearFileBtn.addEventListener('click', clearFile);
 clearFileNoteBtn.addEventListener('click', () => {
   fileNote.value = '';
   toggleClearButton(clearFileNoteBtn, false);
   updateButtonStates();
 });
 uploadFileBtn.addEventListener('click', uploadFile);

 // Share URL events
// Update the share URL input listener in initializeEventListeners()
shareUrlInput.addEventListener('input', async () => {
  const inputValue = shareUrlInput.value.trim();

  // Check if the input contains a password parameter
  if (inputValue.includes('&pass=') || inputValue.includes('?pass=')) {
    try {
      const processedUrl = await handleShareUrlWithPassword(inputValue);
      if (processedUrl !== inputValue) {
        shareUrlInput.value = processedUrl;
      }
    } catch (error) {
      // Silently handle error, user is still typing
    }
  }

  updateButtonStates();
  toggleClearButton(clearShareUrlBtn, shareUrlInput.value.trim());
});

 clearShareUrlBtn.addEventListener('click', clearShareUrl);
 openShareUrlBtn.addEventListener('click', openShareUrl);

 // History events
 toggleHistoryBtn.addEventListener('click', toggleHistory);
 clearAllHistoryBtn.addEventListener('click', clearAllHistory);

 // Add these to the existing initializeEventListeners() function

// Message password protection events
if (passwordProtectedMessage) {
  passwordProtectedMessage.addEventListener('change', () => {
    if (passwordProtectedMessage.checked) {
      if (unencryptedMessage) unencryptedMessage.checked = false;
      if (messagePasswordGroup) messagePasswordGroup.style.display = 'block';
    } else {
      if (messagePasswordGroup) messagePasswordGroup.style.display = 'none';
    }
    updateButtonStates();
  });
}

if (messagePassword) {
  messagePassword.addEventListener('input', () => {
    updateButtonStates();
    toggleClearButton(clearMessagePasswordBtn, messagePassword.value.trim());
  });
}

if (clearMessagePasswordBtn) {
  clearMessagePasswordBtn.addEventListener('click', () => {
    if (messagePassword) messagePassword.value = '';
    toggleClearButton(clearMessagePasswordBtn, false);
    updateButtonStates();
  });
}

// File password protection events
if (passwordProtectedFile) {
  passwordProtectedFile.addEventListener('change', () => {
    if (passwordProtectedFile.checked) {
      if (unencryptedFile) unencryptedFile.checked = false;
      if (filePasswordGroup) filePasswordGroup.style.display = 'block';
    } else {
      if (filePasswordGroup) filePasswordGroup.style.display = 'none';
    }
    updateButtonStates();
  });
}

if (filePassword) {
  filePassword.addEventListener('input', () => {
    updateButtonStates();
    toggleClearButton(clearFilePasswordBtn, filePassword.value.trim());
  });
}

if (clearFilePasswordBtn) {
  clearFilePasswordBtn.addEventListener('click', () => {
    if (filePassword) filePassword.value = '';
    toggleClearButton(clearFilePasswordBtn, false);
    updateButtonStates();
  });
}

// Also update the unencrypted checkboxes to hide password when checked
if (unencryptedMessage) {
  unencryptedMessage.addEventListener('change', () => {
    if (unencryptedMessage.checked && passwordProtectedMessage) {
      passwordProtectedMessage.checked = false;
      if (messagePasswordGroup) messagePasswordGroup.style.display = 'none';
    }
  });
}

if (unencryptedFile) {
  unencryptedFile.addEventListener('change', () => {
    if (unencryptedFile.checked && passwordProtectedFile) {
      passwordProtectedFile.checked = false;
      if (filePasswordGroup) filePasswordGroup.style.display = 'none';
    }
  });
}
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
 // Handle password parameter first
 handlePasswordParameter();

 initializeEventListeners();
 updateButtonStates();

 // Handle deep linking for share URLs
 const urlParams = new URLSearchParams(window.location.search);
 const shareUrl = urlParams.get('url');
 const key = urlParams.get('key');

 if (shareUrl && key) {
   const fullShareUrl = `${window.location.origin}${window.location.pathname}?url=${shareUrl}&key=${key}`;
   shareUrlInput.value = fullShareUrl;
   updateButtonStates();
   toggleClearButton(clearShareUrlBtn, true);
 }
});

function clearMessage() {
  messageInput.value = '';
  messageNote.value = '';
  if (messagePassword) messagePassword.value = '';
  unencryptedMessage.checked = false;
  if (passwordProtectedMessage) passwordProtectedMessage.checked = false;
  if (messagePasswordGroup) messagePasswordGroup.style.display = 'none';
  updateButtonStates();
  toggleClearButton(clearMessageBtn, false);
  toggleClearButton(clearMessageNoteBtn, false);
  toggleClearButton(clearMessagePasswordBtn, false);
}

function clearFile() {
  selectedFile = null;
  fileInput.value = '';
  fileNote.value = '';
  if (filePassword) filePassword.value = '';
  unencryptedFile.checked = false;
  if (passwordProtectedFile) passwordProtectedFile.checked = false;
  if (filePasswordGroup) filePasswordGroup.style.display = 'none';
  fileSelected.style.display = 'none';
  updateButtonStates();
  toggleClearButton(clearFileNoteBtn, false);
  toggleClearButton(clearFilePasswordBtn, false);
}

function clearShareUrl() {
 shareUrlInput.value = '';
 updateButtonStates();
 toggleClearButton(clearShareUrlBtn, false);
}

function handleFileSelect(event) {
 const file = event.target.files[0];
 if (file) {
   setSelectedFile(file);
 }
}

function handleDragOver(event) {
 event.preventDefault();
 fileDropZone.classList.add('drag-over');
}

function handleDragLeave(event) {
 event.preventDefault();
 fileDropZone.classList.remove('drag-over');
}

function handleFileDrop(event) {
 event.preventDefault();
 fileDropZone.classList.remove('drag-over');

 const files = event.dataTransfer.files;
 if (files.length > 0) {
   setSelectedFile(files[0]);
 }
}

function setSelectedFile(file) {
 // Check file size (95KB limit)
 const maxSize = 95 * 1024;
 if (file.size > maxSize) {
   showResult(fileResult, 'error', 'File too large',
     `Maximum file size is 95KB. Your file is ${formatFileSize(file.size)}.`);
   return;
 }

 selectedFile = file;
 fileName.textContent = file.name;
 fileSize.textContent = formatFileSize(file.size);
 fileSelected.style.display = 'block';
 hideResult(fileResult);
 updateButtonStates();
}

function formatFileSize(bytes) {
 if (bytes === 0) return '0 Bytes';
 const k = 1024;
 const sizes = ['Bytes', 'KB', 'MB'];
 const i = Math.floor(Math.log(bytes) / Math.log(k));
 return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

async function uploadMessage() {
  const message = messageInput.value.trim();
  const note = messageNote.value.trim();
  const encrypt = !unencryptedMessage.checked;
  const passwordProtected = passwordProtectedMessage && passwordProtectedMessage.checked;
  const password = messagePassword ? messagePassword.value.trim() : '';

  if (!message) return;
  if (passwordProtected && !password) {
    showResult(messageResult, 'error', 'Password required', 'Please enter a pre-shared password for encryption.');
    return;
  }

  showLoading(messageLoading);
  hideResult(messageResult);
  uploadMessageBtn.disabled = true;

  try {
    const payload = {
      content: message,
      encrypt: encrypt,
      note: note || undefined
    };

    // Add custom key if password protected
    if (passwordProtected && password) {
      payload.customKey = await deriveKeyFromPassword(password);
    }

    const response = await fetch(API_BASE, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    console.log('Message upload response:', result);

    if (result.success) {
      let shareUrl;

      if (passwordProtected) {
        // Create URL with password parameter for easy sharing
        const baseUrl = window.location.origin + '/s/';
        const encodedArweaveUrl = btoa(result.url);
        shareUrl = `${baseUrl}?url=${encodedArweaveUrl}&pass=${password}`;
      } else {
        shareUrl = result.shareUrl || result.url;
      }

      console.log('Share URL found:', shareUrl);

      // Save to history
      saveToHistory({
        type: 'message',
        content: message,
        note: note,
        shareUrl: shareUrl,
        timestamp: Date.now(),
        encrypted: encrypt,
        passwordProtected: passwordProtected
      });

      showResult(messageResult, 'success', 'Message uploaded successfully!',
        passwordProtected ?
          'Your message is password-protected. Share the URL and password together.' :
          'Your message is now stored on Arweave.',
        shareUrl);
      clearMessage();
    } else {
      throw new Error(result.message || 'Upload failed');
    }
  } catch (error) {
    console.error('Upload error:', error);
    showResult(messageResult, 'error', 'Upload failed', error.message);
  } finally {
    hideLoading(messageLoading);
    updateButtonStates();
  }
}

async function uploadFile() {
  if (!selectedFile) return;

  const note = fileNote.value.trim();
  const encrypt = !unencryptedFile.checked;
  const passwordProtected = passwordProtectedFile && passwordProtectedFile.checked;
  const password = filePassword ? filePassword.value.trim() : '';

  if (passwordProtected && !password) {
    showResult(fileResult, 'error', 'Password required', 'Please enter a pre-shared password for encryption.');
    return;
  }

  showLoading(fileLoading);
  hideResult(fileResult);
  uploadFileBtn.disabled = true;

  try {
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('encrypt', encrypt.toString());
    if (note) formData.append('note', note);

    // Add custom key if password protected
    if (passwordProtected && password) {
      formData.append('customKey', await deriveKeyFromPassword(password));
    }

    const response = await fetch(API_BASE, {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    console.log('File upload response:', result);

    if (result.success) {
      let shareUrl;

      if (passwordProtected) {
        // Create URL with password parameter for easy sharing
        const baseUrl = window.location.origin + '/s/';
        const encodedArweaveUrl = btoa(result.url);
        shareUrl = `${baseUrl}?url=${encodedArweaveUrl}&pass=${password}`;
      } else {
        shareUrl = result.shareUrl || result.url;
      }

      console.log('Share URL found:', shareUrl);

      // Save to history
      saveToHistory({
        type: 'file',
        content: selectedFile.name,
        note: note,
        shareUrl: shareUrl,
        timestamp: Date.now(),
        encrypted: encrypt,
        passwordProtected: passwordProtected,
        fileSize: selectedFile.size
      });

      showResult(fileResult, 'success', 'File uploaded successfully!',
        passwordProtected ?
          'Your file is password-protected. Share the URL and password together.' :
          `${selectedFile.name} is now stored on Arweave.`,
        shareUrl);
      clearFile();
    } else {
      throw new Error(result.message || 'Upload failed');
    }
  } catch (error) {
    console.error('Upload error:', error);
    showResult(fileResult, 'error', 'Upload failed', error.message);
  } finally {
    hideLoading(fileLoading);
    updateButtonStates();
  }
}

function openShareUrl() {
 const url = shareUrlInput.value.trim();
 if (url) {
   window.open(url, '_blank');
 }
}

function showLoading(element) {
 element.classList.add('show');
}

function hideLoading(element) {
 element.classList.remove('show');
}

function showResult(element, type, title, message, url = null) {
 console.log('showResult called with:', { type, title, message, url });
 element.className = `result show ${type}`;

 let content = `
   <div class="result-title">
     <span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>
     ${title}
   </div>
   <div class="result-content">${message}</div>
 `;

 if (url) {
   console.log('Adding URL section to result');
   content += `
     <div style="margin: 16px 0;">
       <div style="font-weight: 500; margin-bottom: 8px; color: var(--primary);">
         <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">link</span>
         Share URL:
       </div>
       <div class="result-url">
         <a href="${url}" target="_blank">${url}</a>
       </div>
     </div>
     <div class="btn-row" style="margin-top: 16px;">
       <button class="btn btn-secondary btn-small" onclick="window.open('${url}', '_blank')">
         <span class="material-icons">open_in_new</span>
         Open
       </button>
       <button class="btn btn-secondary btn-small" onclick="copyToClipboard('${url}')">
         <span class="material-icons">content_copy</span>
         Copy
       </button>
       <button class="btn btn-secondary btn-small" onclick="shareUrl('${url}')">
         <span class="material-icons">share</span>
         Share
       </button>
     </div>
   `;
 } else {
   console.log('No URL provided to showResult');
 }

 element.innerHTML = content;
 console.log('Result element updated:', element);
}

function hideResult(element) {
 element.classList.remove('show');
}

async function copyToClipboard(text) {
 try {
   await navigator.clipboard.writeText(text);
   // Show temporary feedback
   const btn = event.target.closest('button');
   const originalText = btn.innerHTML;
   btn.innerHTML = '<span class="material-icons">check</span> Copied!';
   setTimeout(() => {
     btn.innerHTML = originalText;
   }, 2000);
 } catch (err) {
   console.error('Failed to copy:', err);
   // Fallback for older browsers
   const textArea = document.createElement('textarea');
   textArea.value = text;
   document.body.appendChild(textArea);
   textArea.select();
   document.execCommand('copy');
   document.body.removeChild(textArea);
 }
}

async function shareUrl(url) {
 if (navigator.share) {
   try {
     await navigator.share({
       title: 'Thyra Shared Content',
       text: 'Check out this securely stored content',
       url: url
     });
     console.log('Successfully shared');
   } catch (err) {
     console.log('Error sharing:', err);
     // Fallback to copy
     copyToClipboard(url);
   }
 } else {
   // Fallback to copy if Web Share API is not supported
   copyToClipboard(url);
 }
}

// History management functions
function saveToHistory(item) {
 uploadHistory.unshift(item); // Add to beginning
 localStorage.setItem('thyra_upload_history', JSON.stringify(uploadHistory));
 if (historyVisible) {
   renderHistory();
 }
}

function toggleHistory() {
 historyVisible = !historyVisible;
 if (historyVisible) {
   historySection.style.display = 'block';
   toggleHistoryBtn.innerHTML = '<span class="material-icons">visibility_off</span> Hide History';
   renderHistory();
 } else {
   historySection.style.display = 'none';
   toggleHistoryBtn.innerHTML = '<span class="material-icons">visibility</span> Show History';
 }
}

function renderHistory() {
 if (uploadHistory.length === 0) {
   historyList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No uploads yet</div>';
   return;
 }

 const historyHTML = uploadHistory.map((item, index) => {
   const date = new Date(item.timestamp);
   const timeStr = date.toLocaleString();
   const truncatedContent = item.content.length > 50 ?
     item.content.substring(0, 50) + '...' : item.content;

   return `
     <div class="history-item">
       <div class="history-header">
         <div class="history-number">${index + 1}</div>
         <div class="history-timestamp">${timeStr}</div>
       </div>
       <div class="history-content">
         <div class="history-title" title="${item.content}" onclick="window.open('${item.shareUrl}', '_blank')">
           ${item.type === 'file' ? '📁' : '💬'} ${truncatedContent}
         </div>
         ${item.note ? `<div class="history-note">"${item.note}"</div>` : ''}
         <div class="history-url" onclick="copyToClipboard('${item.shareUrl}')" title="Click to copy">
           ${item.shareUrl}
         </div>
       </div>
       <div class="history-actions">
         <button class="history-btn" onclick="window.open('${item.shareUrl}', '_blank')">
           <span class="material-icons" style="font-size: 14px;">open_in_new</span>
           Open
         </button>
         <button class="history-btn" onclick="copyToClipboard('${item.shareUrl}')">
           <span class="material-icons" style="font-size: 14px;">content_copy</span>
           Copy
         </button>
         <button class="history-btn" onclick="shareUrl('${item.shareUrl}')">
           <span class="material-icons" style="font-size: 14px;">share</span>
           Share
         </button>
         <button class="history-btn delete" onclick="deleteHistoryItem(${index})">
           <span class="material-icons" style="font-size: 14px;">delete</span>
           Delete
         </button>
       </div>
     </div>
   `;
 }).join('');

 historyList.innerHTML = historyHTML;
}

function deleteHistoryItem(index) {
 if (confirm('Delete this item from history?')) {
   uploadHistory.splice(index, 1);
   localStorage.setItem('thyra_upload_history', JSON.stringify(uploadHistory));
   renderHistory();
 }
}

function clearAllHistory() {
 if (confirm('Clear all upload history? This cannot be undone.')) {
   uploadHistory = [];
   localStorage.setItem('thyra_upload_history', JSON.stringify(uploadHistory));
   renderHistory();
 }
}
</script>
</body>
</html>

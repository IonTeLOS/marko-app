<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Ephemeral Signer</title>
    <script src="https://unpkg.com/arweave/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/arbundles@0.10.0/dist/bundle.min.js"></script>
</head>
<body>
    <h2>Subsidized Ephemeral Upload (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">Testing ephemeral signing...</textarea><br>
    <button id="uploadBtn">Sign & Upload</button>

    <script>
        const uploadBtn = document.getElementById('uploadBtn');

        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Enter text");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Generating Wallet...";

                const arweave = Arweave.init({});
                
                // 1. Generate an ephemeral wallet (JWK)
                const jwk = await arweave.wallets.generate();
                
                // 2. Wrap text in an ANS-104 Data Item
                // We use the 'arbundles' global from the script tag
                const dataItem = arb.createData(text, {
                    tags: [
                        { name: 'Content-Type', value: 'text/plain' },
                        { name: 'App-Name', value: 'Ephemeral-JS-Uploader' }
                    ]
                }, jwk);

                uploadBtn.innerText = "Signing Binary...";

                // 3. Sign the item with the ephemeral wallet
                // This creates the cryptographic proof Turbo requires
                await dataItem.sign(jwk);

                // 4. Get the raw binary (not JSON!)
                const rawBinary = dataItem.getRaw();

                uploadBtn.innerText = "Sending to Turbo...";

                // 5. POST to Turbo's upload endpoint
                // We send the RAW BYTES, not a JSON string.
                const response = await fetch('https://turbo.ardrive.io/v1/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream'
                    },
                    body: rawBinary
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Turbo rejected: ${errText}`);
                }

                const result = await response.json();
                console.log("Turbo Result:", result);

                alert(`SUCCESS!\nArweave ID: ${result.id}`);
                window.open(`https://arweave.net/${result.id}`, '_blank');

            } catch (error) {
                console.error("Upload Error:", error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Sign & Upload";
            }
        });
    </script>
</body>
</html>

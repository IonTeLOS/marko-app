<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Plain JS Upload</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/arweave/1.15.1/arweave.bundle.js"></script>
</head>
<body>
    <h2>Arweave Free Tier (< 100KB)</h2>
    <input type="file" id="fileInput">
    <button id="uploadBtn">Upload to Arweave</button>

    <script>
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');

        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return alert("Select a file");
            if (file.size > 102400) return alert("File too large (>100KB)");

            // Initialize Arweave inside the click handler to ensure global is caught
            const arweave = window.Arweave.init({
                host: 'arweave.net',
                port: 443,
                protocol: 'https'
            });

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Processing...";

                // 1. Convert file to ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();

                // 2. Generate a "dummy" wallet (Required by the protocol, even if free)
                const tempWallet = await arweave.wallets.generate();
                
                // 3. Create the transaction
                const transaction = await arweave.createTransaction({
                    data: arrayBuffer
                }, tempWallet);

                transaction.addTag('Content-Type', file.type);
                transaction.addTag('App-Name', 'Plain-JS-Upload');

                // 4. Sign the transaction locally
                await arweave.transactions.sign(transaction, tempWallet);

                // 5. Submit to Turbo (The service that provides the free tier)
                const response = await fetch('https://turbo.ardrive.io/v1/tx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transaction)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Turbo rejected: ${errText}`);
                }

                const result = await response.json();
                console.log("Success:", result);
                alert(`SUCCESS!\nArweave ID: ${transaction.id}`);

            } catch (error) {
                console.error("Detailed Error:", error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

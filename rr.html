<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Text Test</title>
</head>
<body>
    <h2>Test: Plain Text to Arweave (< 100KB)</h2>
    
    <div style="margin-bottom: 20px;">
        <textarea id="textInput" rows="5" cols="40" placeholder="Type something to upload..."></textarea><br>
        <button id="uploadTextBtn">Upload Typed Text</button>
    </div>

    <hr>

    <div style="margin-bottom: 20px;">
        <input type="file" id="fileInput" accept=".txt,text/plain">
        <button id="uploadFileBtn">Upload .txt File</button>
    </div>

    <script type="module">
        import Arweave from 'https://esm.sh/arweave@1.15.1';

        const arweave = Arweave.init({
            host: 'arweave.net',
            port: 443,
            protocol: 'https'
        });

        async function uploadData(data, type) {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerText = "Uploading...";

                // 1. Prepare Data (Arweave.js expects Uint8Array)
                const encoder = new TextEncoder();
                const bytes = (typeof data === 'string') ? encoder.encode(data) : new Uint8Array(await data.arrayBuffer());

                if (bytes.byteLength > 102400) return alert("Too large!");

                // 2. Setup Mock Transaction
                const tempWallet = await arweave.wallets.generate();
                const transaction = await arweave.createTransaction({ data: bytes }, tempWallet);
                
                // IMPORTANT: This tag tells the gateway to render as text
                transaction.addTag('Content-Type', 'text/plain');
                transaction.addTag('App-Name', 'Plain-JS-Text-Test');

                await arweave.transactions.sign(transaction, tempWallet);

                // 3. Submit to Turbo
                const response = await fetch('https://turbo.ardrive.io/v1/tx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transaction)
                });

                if (!response.ok) throw new Error(await response.text());

                const result = await response.json();
                const url = `https://arweave.net/${transaction.id}`;
                
                console.log("Success:", result);
                alert(`SUCCESS!\nView text at: ${url}`);
                window.open(url, '_blank');

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                event.target.disabled = false;
                event.target.innerText = event.target.id === 'uploadTextBtn' ? "Upload Typed Text" : "Upload .txt File";
            }
        }

        document.getElementById('uploadTextBtn').addEventListener('click', (e) => {
            const val = document.getElementById('textInput').value;
            if (!val) return alert("Type something!");
            uploadData(val, 'text/plain');
        });

        document.getElementById('uploadFileBtn').addEventListener('click', (e) => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("Select a file!");
            uploadData(file, 'text/plain');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Text Test</title>
</head>
<body>
    <h2>Arweave Free Text Upload (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">Hello Permaweb!</textarea><br>
    <button id="uploadBtn">Upload to Arweave</button>

    <script type="module">
        // 1. We use a version of Arweave.js that works perfectly as a module
        import Arweave from 'https://esm.sh/arweave@1.15.1';

        const uploadBtn = document.getElementById('uploadBtn');

        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Enter text");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Signing...";

                const arweave = Arweave.init({
                    host: 'arweave.net',
                    port: 443,
                    protocol: 'https'
                });

                // 2. Generate a "throwaway" wallet just for the structure
                const jwk = await arweave.wallets.generate();
                
                // 3. Create a standard Arweave Transaction
                const transaction = await arweave.createTransaction({
                    data: text
                }, jwk);

                transaction.addTag('Content-Type', 'text/plain');
                transaction.addTag('App-Name', 'Manual-Arweave-Upload');

                // 4. Sign it locally
                await arweave.transactions.sign(transaction, jwk);

                // 5. POST to a gateway that still allows unbundled L1 transactions
                // Note: We use the '/tx' endpoint of the main gateway
                const response = await fetch('https://arweave.net/tx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transaction)
                });

                // If it returns 200 or 208 (Already received), it's a success
                if (response.status === 200 || response.status === 208) {
                    alert(`SUCCESS! ID: ${transaction.id}`);
                    window.open(`https://arweave.net/${transaction.id}`, '_blank');
                } else {
                    const error = await response.text();
                    throw new Error(`Gateway rejected: ${error}`);
                }

            } catch (error) {
                console.error("Upload Error:", error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

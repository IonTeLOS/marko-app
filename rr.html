<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Text Test</title>
</head>
<body>
    <h2>Arweave Free Tier Text Test</h2>
    
    <textarea id="textInput" rows="5" cols="40" placeholder="Type text here..."></textarea><br>
    <button id="uploadBtn">Upload to Arweave</button>

    <script type="module">
        import Arweave from 'https://esm.sh/arweave@1.15.1';

        const uploadBtn = document.getElementById('uploadBtn');

        // Main upload function
        async function uploadData() {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Please enter some text.");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Processing...";

                const arweave = Arweave.init({
                    host: 'arweave.net',
                    port: 443,
                    protocol: 'https'
                });

                // 1. Generate temp wallet
                const tempWallet = await arweave.wallets.generate();

                // 2. Create Transaction
                const transaction = await arweave.createTransaction({
                    data: text // Arweave.js handles string to buffer conversion here
                }, tempWallet);

                // 3. Add Tags - This is what defines the file for the browser
                transaction.addTag('Content-Type', 'text/plain');
                transaction.addTag('App-Name', 'Plain-JS-Tester');

                // 4. Sign
                await arweave.transactions.sign(transaction, tempWallet);

                // 5. Submit to Turbo
                // Note: We use the v1/tx endpoint. 
                // We must ensure the transaction is sent as a clean JSON object.
                const response = await fetch('https://turbo.ardrive.io/v1/tx', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transaction)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // If you see "Invalid Content Type" here, it's Turbo being picky about JSON format
                    throw new Error(`Turbo Error: ${errorText}`);
                }

                const result = await response.json();
                const url = `https://arweave.net/${transaction.id}`;
                
                alert(`SUCCESS!\nID: ${transaction.id}`);
                console.log("View your text at:", url);
                window.open(url, '_blank');

            } catch (err) {
                console.error("Detailed Error:", err);
                alert(err.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        }

        uploadBtn.addEventListener('click', uploadData);
    </script>
</body>
</html>

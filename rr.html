<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Turbo Free Tier Upload (< 100KB)</title>
</head>
<body>
    <h2>Arweave Free Tier via Turbo (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">Hello Permaweb! This is uploaded via Turbo's free tier.</textarea><br>
    <button id="uploadBtn">Upload to Arweave (Free)</button>
    <div id="status"></div>
    
    <script type="module">
        import Arweave from 'https://esm.sh/arweave@1.15.1';
        import { DataItem, createData } from 'https://esm.sh/arbundles@0.11.0';
        
        const uploadBtn = document.getElementById('uploadBtn');
        const statusDiv = document.getElementById('status');
        
        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Enter text");
            
            try {
                uploadBtn.disabled = true;
                statusDiv.innerHTML = "Creating ephemeral wallet...";
                
                const arweave = Arweave.init({ 
                    host: 'arweave.net', 
                    port: 443, 
                    protocol: 'https' 
                });
                
                // 1. Generate ephemeral wallet
                const jwk = await arweave.wallets.generate();
                
                statusDiv.innerHTML = "Building ANS-104 data item...";
                
                // 2. Create ANS-104 data item (what Turbo expects)
                const dataItem = createData(text, jwk, {
                    tags: [
                        { name: 'Content-Type', value: 'text/plain' },
                        { name: 'App-Name', value: 'Turbo-Free-Tier-Upload' }
                    ]
                });
                
                await dataItem.sign(jwk);
                
                // 3. Get binary representation
                const dataItemBinary = dataItem.getRaw();
                
                statusDiv.innerHTML = `Uploading ${dataItemBinary.length} bytes to Turbo...`;
                
                // 4. Upload to Turbo's free tier endpoint
                const response = await fetch('https://turbo.ardrive.io/v1/tx', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream',
                        // Optional: explicitly request free tier
                        'x-turbo-sponsored': 'true'
                    },
                    body: dataItemBinary
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Turbo error (${response.status}): ${errorText}`);
                }
                
                const result = await response.json();
                const txId = dataItem.id; // or result.id if returned
                
                statusDiv.innerHTML = `
                    <strong>SUCCESS! ðŸŽ‰</strong><br>
                    Transaction ID: <code>${txId}</code><br>
                    <a href="https://arweave.net/${txId}" target="_blank">View on Arweave</a><br>
                    <small>Note: May take 1-2 minutes to become available</small>
                `;
                
                console.log('Upload result:', result);
                
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.innerHTML = `<strong style="color: red;">Error:</strong> ${error.message}`;
            } finally {
                uploadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Final Binary Upload</title>
    <script src="https://unpkg.com/arweave/bundle.js"></script>
</head>
<body>
    <h2>Manual Binary Upload (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">Hello Permaweb! This is a manual binary packet.</textarea><br>
    <button id="uploadBtn">Upload to Arweave</button>

    <script>
        const uploadBtn = document.getElementById('uploadBtn');
        const b64UrlToBuf = (b) => Uint8Array.from(atob(b.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0));

        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Enter text");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Signing...";

                const arweave = Arweave.init({ host: 'arweave.net', port: 443, protocol: 'https' });
                const jwk = await arweave.wallets.generate();
                const owner = b64UrlToBuf(jwk.n);
                const data = new TextEncoder().encode(text);

                // Sign the raw data directly for the subsidized proof
                const signature = await arweave.crypto.sign(jwk, data);

                // Construct the ANS-104 binary packet manually
                const packet = new Uint8Array(2 + 512 + 512 + 1 + 1 + 8 + data.length);
                packet.set([1, 0], 0);             // Signature Type: RSA-PSS
                packet.set(new Uint8Array(signature), 2); // Signature
                packet.set(owner, 514);             // Public Key
                packet.set([0], 1026);              // Target (none)
                packet.set([0], 1027);              // Anchor (none)
                packet.set(new Uint8Array(8).fill(0), 1028); // 0 tags
                packet.set(data, 1036);             // Data

                // CORRECTED ENDPOINT for 2026
                const response = await fetch('https://upload.ardrive.io/v1/tx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    body: packet
                });

                if (!response.ok) throw new Error(await response.text());

                const result = await response.json();
                alert(`SUCCESS! ID: ${result.id}`);
                window.open(`https://arweave.net/${result.id}`, '_blank');

            } catch (error) {
                console.error("Error:", error);
                alert("Upload failed. The service might be temporarily down.");
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

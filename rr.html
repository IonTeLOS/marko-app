<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Pure Binary Upload</title>
</head>
<body>
    <h2>Pure Arweave Binary Upload (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">Hello Permaweb! This is a manual binary packet.</textarea><br>
    <button id="uploadBtn">Upload to Arweave</button>

    <script type="module">
        import Arweave from 'https://esm.sh/arweave@1.15.1';

        const uploadBtn = document.getElementById('uploadBtn');

        // Helper: Convert Base64Url to Uint8Array
        const b64UrlToBuf = (b64) => Uint8Array.from(atob(b64.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0));

        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Enter text");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Generating Identity...";

                const arweave = Arweave.init({ host: 'arweave.net', port: 443, protocol: 'https' });
                const jwk = await arweave.wallets.generate();
                const owner = b64UrlToBuf(jwk.n);
                const data = new TextEncoder().encode(text);

                uploadBtn.innerText = "Signing Binary Packet...";

                // --- MANUALLY BUILDING THE ANS-104 DATA ITEM ---
                // We bypass the JSON logic and build a raw byte array.
                // Format: [SignatureType(2) | Signature(512) | Owner(512) | Target(1) | Anchor(1) | TagCount(8) | Data]
                
                const signatureType = new Uint8Array([1, 0]); // RSA-PSS
                const target = new Uint8Array([0]);           // No target
                const anchor = new Uint8Array([0]);           // No anchor
                
                // We use Arweave.js just to sign the deepHash of the data
                // This satisfies the cryptographic proof for Turbo
                const signature = await arweave.crypto.sign(jwk, data);

                // Concatenate into a single binary blob
                const packet = new Uint8Array([
                    ...signatureType,
                    ...signature,
                    ...owner,
                    ...target,
                    ...anchor,
                    ...new Uint8Array(8).fill(0), // No tags for simplicity to avoid 400s
                    ...data
                ]);

                uploadBtn.innerText = "POSTing Raw Binary...";

                // We hit the /v1/upload endpoint with OCTET-STREAM
                const response = await fetch('https://turbo.ardrive.io/v1/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    body: packet
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    throw new Error(`Turbo rejected binary: ${errorMsg}`);
                }

                const result = await response.json();
                alert(`SUCCESS!\nArweave ID: ${result.id}`);
                window.open(`https://arweave.net/${result.id}`, '_blank');

            } catch (error) {
                console.error("Upload Error:", error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

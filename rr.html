<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Free Upload</title>
</head>
<body>
    <h2>Arweave Free Tier (< 100KB)</h2>
    <input type="file" id="fileInput">
    <button id="uploadBtn">Upload to Arweave</button>

    <script type="module">
        // Using esm.sh for a clean, bundler-free import of Arweave.js
        import Arweave from 'https://esm.sh/arweave@1.15.1';

        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');

        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return alert("Select a file");
            
            // Limit for Turbo's free tier
            if (file.size > 102400) return alert("File too large (>100KB)");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Processing...";

                const arweave = Arweave.init({
                    host: 'arweave.net',
                    port: 443,
                    protocol: 'https'
                });

                // 1. Create a "mock" wallet for signing (required for the transaction format)
                const tempWallet = await arweave.wallets.generate();
                const arrayBuffer = await file.arrayBuffer();

                // 2. Create the Arweave Transaction
                const transaction = await arweave.createTransaction({
                    data: new Uint8Array(arrayBuffer)
                }, tempWallet);

                // 3. Add tags (This defines how the file is viewed on Arweave)
                transaction.addTag('Content-Type', file.type || 'application/octet-stream');
                transaction.addTag('App-Name', 'Turbo-Free-Upload-Plain-JS');

                // 4. Sign locally (No cost)
                await arweave.transactions.sign(transaction, tempWallet);

                // 5. Submit to Turbo
                // IMPORTANT: Headers must be exactly 'application/json' for the POST body
                const response = await fetch('https://turbo.ardrive.io/v1/tx', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transaction)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Turbo rejected: ${errText}`);
                }

                const result = await response.json();
                console.log("Success Result:", result);
                
                alert(`SUCCESS! Arweave ID: ${transaction.id}`);
                console.log("View your file at: https://arweave.net/" + transaction.id);

            } catch (error) {
                console.error("Upload Error:", error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

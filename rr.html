<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Free Text Upload</title>
</head>
<body>
    <h2>Arweave Free Text Upload (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">Hello Permaweb!</textarea><br>
    <button id="uploadBtn">Upload to Arweave</button>

    <script type="module">
        // Using the one library we know loads correctly for you
        import Arweave from 'https://esm.sh/arweave@1.15.1';

        const uploadBtn = document.getElementById('uploadBtn');

        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Please enter text");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Uploading...";

                // 1. Convert text to a Blob
                const blob = new Blob([text], { type: 'text/plain' });

                // 2. We bypass the "Transaction" logic entirely.
                // We use the Arweave 'chunk' upload method which many gateways
                // allow for small, unauthenticated data chunks.
                const response = await fetch('https://arweave.net/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: blob
                });

                // If the gateway rejects direct raw data, we hit the Turbo 
                // "Raw Data" endpoint which is the last fallback for un-bundled bytes.
                if (!response.ok) {
                    console.log("Gateway rejected, trying Turbo Raw...");
                    const turboResponse = await fetch('https://turbo.ardrive.io/v1/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/octet-stream' },
                        body: blob
                    });

                    if (!turboResponse.ok) {
                        const err = await turboResponse.text();
                        throw new Error(`All providers rejected: ${err}`);
                    }

                    const result = await turboResponse.json();
                    alert(`SUCCESS! ID: ${result.id}`);
                    window.open(`https://arweave.net/${result.id}`, '_blank');
                    return;
                }

                const txId = await response.text();
                alert(`SUCCESS! ID: ${txId}`);
                window.open(`https://arweave.net/${txId}`, '_blank');

            } catch (error) {
                console.error("Final Fallback Error:", error);
                alert("This gateway requires a signed bundle. To do this in plain JS, we must use a different CDN for arbundles.");
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

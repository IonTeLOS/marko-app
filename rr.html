<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave Free Upload</title>
</head>
<body>
    <h2>Arweave Free Tier (< 100KB)</h2>
    <textarea id="textInput" rows="5" cols="40">This is a verified binary upload.</textarea><br>
    <button id="uploadBtn">Upload to Arweave</button>

    <script type="module">
        // Using the reliable ESM distributions
        import Arweave from 'https://esm.sh/arweave@1.15.1';
        import { TurboFactory } from 'https://esm.sh/@ardrive/turbo-sdk@1.1.10';

        const uploadBtn = document.getElementById('uploadBtn');

        uploadBtn.addEventListener('click', async () => {
            const text = document.getElementById('textInput').value;
            if (!text) return alert("Please enter text");

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerText = "Generating Ephemeral Identity...";

                const arweave = Arweave.init({ host: 'arweave.net', port: 443, protocol: 'https' });
                
                // 1. Create ephemeral wallet
                const jwk = await arweave.wallets.generate();
                
                // 2. Initialize Turbo with the ephemeral signer
                // This 'signer' object is what builds the binary ANS-104 structure
                const turbo = TurboFactory.unauthenticated();

                // 3. Prepare data as a Buffer/Uint8Array
                const data = new TextEncoder().encode(text);

                uploadBtn.innerText = "Uploading Binary Bundle...";

                // 4. Use the internal 'uploadService' to POST the data
                // This avoids the /v1/tx endpoint and uses the binary-friendly /v1/upload
                const result = await turbo.uploadSignedDataItem({
                    dataItem: {
                        data,
                        tags: [
                            { name: 'Content-Type', value: 'text/plain' },
                            { name: 'App-Name', value: 'Verified-Binary-Upload' }
                        ]
                    },
                    signer: {
                        sign: async (data) => await arweave.crypto.sign(jwk, data),
                        publicKey: jwk.n,
                        signatureType: 1 // RSA-PSS
                    }
                });

                console.log("Success:", result);
                alert(`SUCCESS!\nArweave ID: ${result.id}`);
                window.open(`https://arweave.net/${result.id}`, '_blank');

            } catch (error) {
                console.error("Upload Error:", error);
                alert("Error: " + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "Upload to Arweave";
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RSS / Atom / JSON Feed Discovery</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --bg: #0f172a;
    --panel: #020617;
    --text: #e5e7eb;
    --muted: #94a3b8;
    --accent: #38bdf8;
    --error: #f87171;
  }

  * {
    box-sizing: border-box;
    overflow-wrap: anywhere;
  }

  body {
    margin: 0;
    padding: 1rem;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  h1 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
  }

  .controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  input {
    flex: 1;
    min-width: 220px;
    padding: 0.6rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
  }

  button {
    padding: 0.6rem 1rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background: var(--accent);
    color: #020617;
    cursor: pointer;
  }

  .feed {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--panel);
    border-radius: 10px;
  }

  .feed h2 {
    margin: 0 0 0.25rem 0;
    font-size: 1.15rem;
  }

  .source {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  .item {
    border-top: 1px solid #1e293b;
    padding-top: 0.75rem;
    margin-top: 0.75rem;
  }

  .item img {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin-top: 0.5rem;
    display: block;
  }

  .item a {
    color: var(--accent);
    text-decoration: none;
  }

  .meta {
    font-size: 0.8rem;
    color: var(--muted);
  }

  .error {
    margin-top: 1rem;
    color: var(--error);
  }
</style>
</head>

<body>

<h1>üß≠ Feed Discovery Tester</h1>

<div class="controls">
  <input id="url" placeholder="https://example.com" />
  <button onclick="discover()">Discover</button>
</div>

<div id="out"></div>

<script>
/* ================================
   CONFIG
================================ */

const PROXY = url =>
  "https://api.allorigins.win/raw?url=" + encodeURIComponent(url)

const COMMON_FEED_PATHS = [
  "/feed",
  "/rss",
  "/rss.xml",
  "/feed.xml",
  "/atom.xml",
  "/index.xml",
  "/feed.json"
]

/* ================================
   STATE
================================ */

const seen = new Set()
let terminalFeedFound = false

/* ================================
   ENTRY
================================ */

async function discover() {
  const input = document.getElementById("url").value.trim()
  const out = document.getElementById("out")
  out.innerHTML = ""
  seen.clear()
  terminalFeedFound = false

  if (!input) return

  try {
    // Phase 1Ô∏è‚É£: direct attempt
    await tryCandidate(input, "direct")
    if (terminalFeedFound) return

    // Phase 2Ô∏è‚É£: fetch HTML
    const html = await fetchText(input)
    const doc = new DOMParser().parseFromString(html, "text/html")

    // Phase 3Ô∏è‚É£: <link rel="alternate">
    discoverFromLinks(doc, input)
    if (terminalFeedFound) return

    // Phase 4Ô∏è‚É£: anchor heuristics
    discoverFromAnchors(doc, input)
    if (terminalFeedFound) return

    // Phase 5Ô∏è‚É£: well-known paths
    discoverFromCommonPaths(input)

  } catch (e) {
    out.innerHTML = `<div class="error">‚ùå ${e.message}</div>`
  }
}

/* ================================
   DISCOVERY PHASES
================================ */

function discoverFromLinks(doc, base) {
  doc.querySelectorAll('link[rel="alternate"][type]').forEach(l => {
    if (terminalFeedFound) return
    if (/rss|atom|json/i.test(l.type)) {
      tryCandidate(new URL(l.href, base).href, "auto-discovery")
    }
  })
}

function discoverFromAnchors(doc, base) {
  doc.querySelectorAll("a[href]").forEach(a => {
    if (terminalFeedFound) return
    if (/rss|atom|feed|subscribe/i.test(a.textContent)) {
      tryCandidate(new URL(a.href, base).href, "anchor")
    }
  })
}

function discoverFromCommonPaths(base) {
  COMMON_FEED_PATHS.forEach(p => {
    if (terminalFeedFound) return
    tryCandidate(new URL(p, base).href, "well-known path")
  })
}

/* ================================
   CANDIDATE HANDLING
================================ */

async function tryCandidate(url, source) {
  if (seen.has(url) || terminalFeedFound) return
  seen.add(url)

  try {
    const text = await fetchText(url)

    let feed = null

    if (text.trim().startsWith("{")) {
      feed = parseJSONFeed(JSON.parse(text), url)
    } else {
      feed = parseXMLFeed(text, url)
    }

    if (!feed) return

    renderFeed(feed, source)

    if (isHighConfidence(feed, source)) {
      terminalFeedFound = true
      console.log("üõë Early exit: high-confidence feed", feed.url)
    }

  } catch (_) {}
}

async function fetchText(url) {
  const res = await fetch(PROXY(url))
  if (!res.ok) throw new Error("Fetch failed")
  return res.text()
}

/* ================================
   PARSING
================================ */

function parseXMLFeed(text, url) {
  const xml = new DOMParser().parseFromString(text, "application/xml")
  if (xml.querySelector("parsererror")) return null

  const channel = xml.querySelector("channel")
  const feed = xml.querySelector("feed")
  if (!channel && !feed) return null

  const title =
    channel?.querySelector("title")?.textContent ||
    feed?.querySelector("title")?.textContent

  const items = channel
    ? [...xml.querySelectorAll("item")]
    : [...xml.querySelectorAll("entry")]

  return {
    url,
    title,
    items: items.map(i => ({
      title: i.querySelector("title")?.textContent,
      link:
        i.querySelector("link")?.getAttribute("href") ||
        i.querySelector("link")?.textContent,
      date:
        i.querySelector("pubDate")?.textContent ||
        i.querySelector("updated")?.textContent,
      content:
        i.querySelector("description")?.textContent ||
        i.querySelector("summary")?.textContent ||
        i.querySelector("content")?.textContent
    }))
  }
}

function parseJSONFeed(feed, url) {
  if (!feed || !feed.items) return null
  return {
    url,
    title: feed.title,
    items: feed.items
  }
}

/* ================================
   CONFIDENCE GATE (BINARY)
================================ */

function isHighConfidence(feed, source) {
  if (source !== "auto-discovery" && source !== "direct") return false
  if (!feed.title) return false
  if (feed.items.length < 5) return false
  if (/comments|tag|category/i.test(feed.url)) return false
  return true
}

/* ================================
   RENDERING
================================ */

function renderFeed(feed, source) {
  const out = document.getElementById("out")
  const box = document.createElement("div")
  box.className = "feed"

  box.innerHTML = `
    <h2>${feed.title || "Untitled feed"}</h2>
    <div class="source">Found via: ${source} ¬∑ ${feed.url}</div>
  `

  feed.items.forEach(i => {
    const div = document.createElement("div")
    div.className = "item"
    div.innerHTML = `
      <a href="${i.url || i.link || "#"}" target="_blank">
        <strong>${i.title || "(no title)"}</strong>
      </a>
      ${i.date ? `<div class="meta">${i.date}</div>` : ""}
      ${i.content_html || i.content_text || i.content
        ? `<div>${i.content_html || i.content_text || i.content}</div>`
        : ""}
    `
    box.appendChild(div)
  })

  out.appendChild(box)
}
</script>

</body>
</html>

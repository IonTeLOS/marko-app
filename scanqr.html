<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Scan Payment QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #000;
    color: #fff;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  #videoWrapper { position: relative; flex: 1; }
  #video { width: 100%; height: 100%; object-fit: cover; }

  .frame {
    position: absolute; top: 50%; left: 50%;
    width: 260px; height: 260px;
    transform: translate(-50%, -50%);
    border: 4px solid rgba(255,255,255,0.6);
    border-radius: 15px;
    pointer-events: none;
  }

  #controls {
    padding: 8px;
    background: rgba(0,0,0,0.6);
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  button {
    padding: 10px 14px;
    background: #2a7cff; border: none;
    color: #fff; border-radius: 8px;
    font-size: 14px;
  }
  button.secondary { background: #444; }

  #status {
    padding: 10px;
    text-align: center;
    background: rgba(0,0,0,0.5);
    font-size: 14px;
  }

  /* tap overlay */
  #tapOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    text-align: center;
    padding: 20px;
    font-family: system-ui, sans-serif;
  }
</style>
</head>

<body>

<!-- TAP TO ENABLE HAPTICS -->
<div id="tapOverlay" onclick="enableHaptics()">
  <div style="font-size:18px; font-weight:500; margin-bottom:10px;">
    Scan
  </div>
  <div style="font-size:13px; opacity:0.7;">
   ____
  </div>
</div>

<div id="videoWrapper">
  <video id="video" autoplay playsinline></video>
  <div class="frame"></div>
</div>

<div id="status">Loading scanner…</div>

<div id="controls">
  <button onclick="switchCamera()">Switch Camera</button>
  <button class="secondary" onclick="toggleFlash()" id="flashBtn">Flashlight</button>
</div>

<script type="module">
import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

const WALLET_URL = window.location.origin + "/w1.html";

/* ---------------------------------------------------------
   SCI-FI BLIP SOUND (base64 WAV)
--------------------------------------------------------- */
const beepAudio = new Audio(
  "data:audio/wav;base64,UklGRqgAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YSgAAACAgICAf4B/gH+B/4CAgICAgIB/gH+A/4CAgICAgH+Af4B/gICAgH+Af4CAgH+Af4B/gICAf4B/gH+AgIB/gH+Af4CAgH+Af4B/gICAL4AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA"
);

let scanner = null;
let cameras = [];
let currentIndex = 0;
let torchOn = false;
let already = false;

/* ---------------------------------------------------------
   Tap → enable haptics + sound
--------------------------------------------------------- */
window.enableHaptics = () => {
  try { navigator.vibrate?.(20); } catch {}
  // try { beepAudio.play().catch(()=>{}); } catch {}

  const overlay = document.getElementById("tapOverlay");
  overlay.style.display = "none";
};

/* ---------------------------------------------------------
   Init scanner
--------------------------------------------------------- */
async function init() {
  document.getElementById("status").textContent = "Initializing camera…";

  cameras = await QrScanner.listCameras(true);

  if (!cameras.length) {
    document.getElementById("status").textContent = "No cameras found.";
    return;
  }

  await startCameraWithPriority();
}

/* ---------------------------------------------------------
   Camera start logic (rear first)
--------------------------------------------------------- */
async function startCameraWithPriority() {
  const video = document.getElementById("video");
  const status = document.getElementById("status");

  if (scanner) scanner.stop();

  // Try rear camera preferences
  const tries = [
    { preferredCamera: "environment" },
    { facingMode: { ideal: "environment" }},
    { deviceId: cameras[0].id }
  ];

  for (const t of tries) {
    try {
      scanner = new QrScanner(video, r => onScan(r), {
        returnDetailedScanResult: true,
        ...t
      });
      await scanner.start();
      status.textContent = "Scanning…";
      return;
    } catch (e) {}
  }

  status.textContent = "Unable to access camera.";
}

/* ---------------------------------------------------------
   Sound + vibration
--------------------------------------------------------- */
function feedback() {
  try { navigator.vibrate?.(50); } catch {}

  try {
    beepAudio.currentTime = 0;
    beepAudio.play().catch(()=>{});
  } catch {}
}

/* ---------------------------------------------------------
   QR scan handler
--------------------------------------------------------- */
function onScan(result) {
  if (!result || already) return;
  already = true;

  feedback();

  document.getElementById("status").textContent = "QR detected…";

  const text = result.data;

  if (text.startsWith("ar://")) {
    openWallet(text);
  } else if (text.includes("?link=ar://")) {
    window.location.href = text;
  } else {
    document.getElementById("status").textContent = "Invalid payment QR.";
    already = false;
  }
}

/* ---------------------------------------------------------
   Deep link into wallet
--------------------------------------------------------- */
function openWallet(arUri) {
  const final = WALLET_URL + "?link=" + encodeURIComponent(arUri);
  setTimeout(() => window.location.href = final, 350);
}

/* ---------------------------------------------------------
   Camera switch
--------------------------------------------------------- */
async function switchCamera() {
  if (!cameras.length || !scanner) return;
  already = false;

  currentIndex = (currentIndex + 1) % cameras.length;
  await scanner.setCamera(cameras[currentIndex].id);

  document.getElementById("status").textContent = "Scanning…";
}

/* ---------------------------------------------------------
   Flashlight toggle
--------------------------------------------------------- */
async function toggleFlash() {
  if (!scanner) return;

  const hasFlash = await scanner.hasFlash();
  if (!hasFlash) {
    alert("Flashlight not supported");
    return;
  }

  torchOn = !torchOn;
  scanner.toggleFlash();
}

init();
</script>

</body>
</html>

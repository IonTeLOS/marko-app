<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Scan Payment QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: #000;
    color: #fff;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
  }

  .scan-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 260px;
    height: 260px;
    transform: translate(-50%, -50%);
    border: 4px solid rgba(255,255,255,0.5);
    border-radius: 12px;
    pointer-events: none;
  }

  #status {
    padding: 12px;
    text-align: center;
    background: rgba(0,0,0,0.6);
    font-size: 14px;
  }

  #controls {
    padding: 8px;
    background: rgba(0,0,0,0.6);
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  button {
    background: #2a7cff;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
  }

  button.secondary {
    background: #333;
  }
</style>
</head>

<body>

<div style="position:relative; flex:1;">
  <video id="video" autoplay playsinline muted></video>
  <div class="scan-frame"></div>
</div>

<div id="status">Loading scanner…</div>

<div id="controls">
  <button onclick="toggleCamera()">Switch Camera</button>
  <button class="secondary" onclick="toggleFlash()" id="flashBtn">Flashlight</button>
</div>

<script type="module">
import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

const WALLET_URL = window.location.origin + "/w1.html";

let currentCam = null;
let cameras = [];
let scanner = null;
let alreadyScanned = false;
let torchOn = false;

async function startScanner() {
  document.getElementById("status").textContent = "Starting camera…";

  cameras = await QrScanner.listCameras(true);
  if (!cameras.length) {
    document.getElementById("status").textContent = "No camera found";
    return;
  }

  currentCam = cameras[0].id;

  scanner = new QrScanner(
    document.getElementById("video"),
    result => handleQR(result),
    { preferredCamera: currentCam }
  );

  await scanner.start();
  document.getElementById("status").textContent = "Scanning…";
}

function handleQR(text) {
  if (alreadyScanned) return;
  alreadyScanned = true;
  document.getElementById("status").textContent = "QR detected…";

  console.log("QR:", text);

  if (text.startsWith("ar://")) {
    openWallet(text);
  } else if (text.includes("?link=ar://")) {
    window.location.href = text;
  } else {
    document.getElementById("status").textContent = "Not a valid payment QR";
    alreadyScanned = false;
  }
}

function openWallet(arUri) {
  const url = WALLET_URL + "?link=" + encodeURIComponent(arUri);
  document.getElementById("status").textContent = "Opening wallet…";
  setTimeout(() => window.location.href = url, 300);
}

async function toggleCamera() {
  if (!cameras.length) return;
  alreadyScanned = false;

  const idx = cameras.findIndex(cam => cam.id === currentCam);
  const next = cameras[(idx + 1) % cameras.length];

  currentCam = next.id;
  await scanner.setCamera(next.id);

  document.getElementById("status").textContent = "Scanning…";
}

async function toggleFlash() {
  const hasFlash = await scanner.hasFlash();
  if (!hasFlash) {
    alert("Flashlight not supported");
    return;
  }
  torchOn = !torchOn;
  scanner.toggleFlash();
}

startScanner();
</script>

</body>
</html>

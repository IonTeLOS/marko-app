<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shortlink Creator</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .input-field {
            position: relative;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-bottom: 1px solid #9e9e9e;
            outline: none;
            font-size: 16px;
        }
        .btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            font-size: 16px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 14px;
        }
        .material-icons {
            margin-right: 5px;
        }
        .hidden {
            display: none;
        }
        .separator {
            border-top: 1px solid #e0e0e0;
            margin: 20px 0;
        }
        .link-list {
            list-style-type: none;
            padding: 0;
        }
        .link-list li {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .link-list li.expired {
            color: #9e9e9e;
        }
        .link-list li.once {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="createForm">
            <div class="input-field">
                <input type="text" id="urlInput" placeholder="Enter URL to shorten">
            </div>
            <button id="createBtn" class="btn">
                <i class="material-icons">link</i>
                Create Shortlink
            </button>
            <button id="moreOptionsBtn" class="btn btn-small">
                <i class="material-icons">more_horiz</i>
                More Options
            </button>
            <div id="moreOptions" class="hidden">
                <div class="input-field">
                    <input type="text" id="aliasInput" placeholder="Custom alias (optional)">
                </div>
                <div class="input-field">
                    <input type="date" id="expiryDate">
                </div>
                <label>
                    <input type="checkbox" id="onceCheckbox">
                    Use once
                </label>
            </div>
        </div>
        <div id="result" class="hidden">
            <p>Shortlink created: <span id="createdLink"></span></p>
            <button id="testBtn" class="btn hidden">
                <i class="material-icons">open_in_new</i>
                Open Link
            </button>
            <button id="restartBtn" class="btn hidden">
                <i class="material-icons">refresh</i>
                Create Another
            </button>
        </div>
        <div class="separator"></div>
        <ul id="linkList" class="link-list"></ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createForm = document.getElementById('createForm');
            const result = document.getElementById('result');
            const moreOptionsBtn = document.getElementById('moreOptionsBtn');
            const moreOptions = document.getElementById('moreOptions');
            const createBtn = document.getElementById('createBtn');
            const urlInput = document.getElementById('urlInput');
            const aliasInput = document.getElementById('aliasInput');
            const expiryDate = document.getElementById('expiryDate');
            const onceCheckbox = document.getElementById('onceCheckbox');
            const createdLink = document.getElementById('createdLink');
            const testBtn = document.getElementById('testBtn');
            const restartBtn = document.getElementById('restartBtn');
            const linkList = document.getElementById('linkList');

            moreOptionsBtn.addEventListener('click', () => {
                moreOptions.classList.toggle('hidden');
            });

            createBtn.addEventListener('click', createShortlink);
            restartBtn.addEventListener('click', () => {
                location.reload();
            });

            function createShortlink() {
                const url = urlInput.value;
                let alias = aliasInput.value;
                const expires = expiryDate.value ? new Date(expiryDate.value + 'T23:59:00').toISOString() : '';
                const once = onceCheckbox.checked;
                const owner = localStorage.getItem('userEmail') || 'anon@anon.org';

                // Validate and normalize alias
                if (alias) {
                    alias = alias.trim() // Remove leading and trailing spaces
                        .toLowerCase() // Convert to lowercase
                        .replace(/\s+/g, '-') // Replace internal spaces with hyphens
                        .replace(/[^a-z0-9-_]/g, ''); // Remove invalid characters

                    // Limit the alias length to 30 characters
                    if (alias.length > 30) {
                        alias = alias.substring(0, 30);
                    }
                }

                let apiUrl = `https://marko-app.netlify.app/s/?redirectpath=${encodeURIComponent(url)}&owner=${encodeURIComponent(owner)}`;
                if (alias) apiUrl += `&path=${encodeURIComponent(alias)}`;
                if (once) apiUrl += '&once=true';
                if (expires) apiUrl += `&expires=${encodeURIComponent(expires)}`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.shortlink) {
                            createdLink.textContent = data.shortlink;
                            createForm.classList.add('hidden');
                            result.classList.remove('hidden');

                            // Create a button to open the link
                            if (!once) {
                                testBtn.classList.remove('hidden');
                                testBtn.addEventListener('click', () => window.open(data.shortlink, '_blank'));
                            } else {
                                testBtn.classList.add('hidden');
                                result.insertAdjacentHTML('beforeend', '<p>Opening this link will invalidate it.</p>');
                            }

                            restartBtn.classList.remove('hidden');
                            saveShortlink(data);
                            updateLinkList();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            function saveShortlink(data) {
                const shortlinks = JSON.parse(localStorage.getItem('shortlinks') || '[]');
                shortlinks.push([
                    data.shortlink,
                    data.redirectPath,
                    data.expires || '',
                    data.once ? 'true' : 'false'
                ]);
                localStorage.setItem('shortlinks', JSON.stringify(shortlinks));
            }

            function updateLinkList() {
                linkList.innerHTML = '';
                const shortlinks = JSON.parse(localStorage.getItem('shortlinks') || '[]');
                shortlinks.forEach((link, index) => {
                    const li = document.createElement('li');
                    const now = new Date();
                    const expired = link[2] && new Date(link[2]) < now;
                    li.textContent = `${index + 1}. ${link[0]} -> ${link[1]}`;
                    if (expired) li.classList.add('expired');
                    if (link[3] === 'true') li.classList.add('once');
                    linkList.appendChild(li);
                });
            }

            // Set min and max date for expiry date picker
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const fiveYearsLater = new Date();
            fiveYearsLater.setFullYear(fiveYearsLater.getFullYear() + 5);
            expiryDate.min = tomorrow.toISOString().split('T')[0];
            expiryDate.max = fiveYearsLater.toISOString().split('T')[0];

            // Initial update of the link list
            updateLinkList();
        });
    </script>
</body>
</html>

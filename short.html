<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shortlink Creator</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
    color: #333;
}

.container {
    max-width: 600px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.input-field {
    position: relative;
    margin-bottom: 20px;
}

input[type="text"], input[type="date"], input[type="password"] {
    width: 100%;
    padding: 12px;
    border: 1px solid #9e9e9e;
    border-radius: 4px;
    outline: none;
    font-size: 16px;
    box-sizing: border-box;
}

.btn {
    background-color: #2196F3;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    font-size: 16px;
    box-sizing: border-box;
    width: 100%; /* Make button full-width on small screens */
    text-align: center;
    margin-bottom: 10px; /* Space between buttons */
}

.btn-small {
    padding: 12px 20px;
    font-size: 16px;
    width: 100%; /* Make button full-width on small screens */
}

.material-icons {
    margin-right: 8px;
}

.hidden {
    display: none;
}

.separator {
    border-top: 1px solid #e0e0e0;
    margin: 20px 0;
}

.link-list {
    list-style-type: none;
    padding: 0;
}

.link-list li {
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
    box-sizing: border-box;
    margin-bottom: 10px;
}

.link-list li.expired {
    color: #9e9e9e;
}

.link-list li.once {
    color: #2196F3;
}

.link-list a {
    display: block;
    padding: 10px;
    border-radius: 4px;
    text-decoration: none;
    margin-bottom: 5px; /* Space between links */
}

.fullpath {
    display: block;
    padding: 10px;
    border-radius: 4px;
    text-decoration: none;
    margin-bottom: 5px; /* Space between links */
    border: 2px solid #2196F3;
    background-color: #e3f2fd;
    color: #2196F3;
    text-decoration: underline; /* Underline to resemble a link */
    cursor: pointer; /* Pointer cursor to mimic link behavior */
}

.link-list a.redirectpath {
    border: 2px solid #4caf50;
    background-color: #e8f5e9;
    color: #4caf50;
}

.link-list a:hover {
    opacity: 0.8;
}

#moreOptions {
    padding-top: 10px;
}

#expiryDate {
    margin-top: 5px;
}

#expiryDateInfo {
    color: #757575;
}

#onceCheckbox {
    margin-bottom: 15px;
}

/* Responsive Design */
@media (max-width: 600px) {
    .btn, .btn-small {
        font-size: 14px;
        padding: 10px 15px;
    }

    .container {
        padding: 10px;
    }

    .input-field {
        margin-bottom: 15px;
    }

    .separator {
        margin: 15px 0;
    }

    .link-list li {
        padding: 8px;
        margin-bottom: 8px;
    }
}
.password-container {
    display: flex;
    align-items: center;
    gap: 8px; /* Space between icons */
}

.password-container .material-icons {
    cursor: pointer;
    margin-right: 8px; /* Space between icon and password text */
}

.password {
    margin-left: 8px;
    font-weight: bold;
}

.hidden {
    display: none;
}

.password.visible {
    display: inline;
}

    </style>
</head>
<body>
    <div class="container">
        <div id="createForm">
            <div class="input-field">
                <input type="text" id="urlInput" placeholder="Enter URL to shorten">
            </div>
            <button id="moreOptionsBtn" class="btn btn-small" style="float: right;">
                <i class="material-icons">more_horiz</i>
                More Options
            </button>
            <div id="moreOptions" class="hidden">
                <div class="input-field">
                    <input type="text" id="aliasInput" placeholder="Custom alias (optional)" maxlength="30">
                </div>
                <div class="input-field">
                    <input type="date" id="expiryDate">
                    <small id="expiryDateInfo" style="color: #757575;">Pick an expiration date (optional)</small>
                </div>
                <label>
                    <input type="checkbox" id="onceCheckbox">
                    Use once (optional)
                </label>
                <div class="input-field">
                    <input type="password" id="passwordInput" placeholder="Password (optional)" maxlength="16" pattern="^[^\s]*$">
                </div>
                <div class="input-field">
                    <input type="text" id="shareMessageInput" placeholder="Custom share message (optional)" maxlength="100">
                </div>
            </div>
            <button id="createBtn" class="btn">
                    <i class="material-icons">link</i>
                Create Shortlink
            </button>
        </div>
        <div id="result" class="hidden">
            <p id="resultMessage"></p>
            <button id="testBtn" class="btn hidden">
                <i class="material-icons">open_in_new</i>
                Open Link
            </button>
            <button id="restartBtn" class="btn hidden">
                <i class="material-icons">refresh</i>
                Create Another
            </button>
        </div>
        <div class="separator"></div>
        <ul id="linkList" class="link-list"></ul>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const createForm = document.getElementById('createForm');
    const result = document.getElementById('result');
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    const moreOptions = document.getElementById('moreOptions');
    const createBtn = document.getElementById('createBtn');
    const urlInput = document.getElementById('urlInput');
    const aliasInput = document.getElementById('aliasInput');
    const expiryDate = document.getElementById('expiryDate');
    const onceCheckbox = document.getElementById('onceCheckbox');
    const passwordInput = document.getElementById('passwordInput');
    const resultMessage = document.getElementById('resultMessage');
    const testBtn = document.getElementById('testBtn');
    const restartBtn = document.getElementById('restartBtn');
    const linkList = document.getElementById('linkList');
    const shareMessageInput = document.getElementById('shareMessageInput');

    moreOptionsBtn.addEventListener('click', () => {
        if (!moreOptions.classList.contains('hidden')) {
            // More options are already visible, hide them
            const fields = [aliasInput, expiryDate, passwordInput];
            const nonEmptyFields = fields.filter(field => field.value.trim() !== '');

            if (nonEmptyFields.length > 0) {
                if (confirm('Custom options have been cleared. Continue?')) {
                    fields.forEach(field => field.value = '');
                    alert('Custom options cleared.');
                }
            }
            moreOptions.classList.add('hidden');
        } else {
            moreOptions.classList.remove('hidden');
        }
    });

    createBtn.addEventListener('click', createShortlink);
    restartBtn.addEventListener('click', () => {
        location.reload();
    });

    function isValidUrl(url) {
        try {
            new URL(url);
            return true;
        } catch {
            return false;
        }
    }

    function createShortlink() {
        const url = urlInput.value;
        if (!isValidUrl(url)) {
            alert("The provided URL is invalid.");
            return;
        }

        let alias = aliasInput.value;
        const expires = expiryDate.value ? new Date(expiryDate.value + 'T23:59:00').toISOString() : '';
        const once = onceCheckbox.checked;
        const password = passwordInput.value;
        const owner = localStorage.getItem('userEmail') || 'anon@anon.org';

        // Validate and normalize alias
        if (alias) {
            alias = alias.trim() // Remove leading and trailing spaces
                .toLowerCase() // Convert to lowercase
                .replace(/\s+/g, '-') // Replace internal spaces with hyphens
                .replace(/[^a-z0-9-_]/g, ''); // Remove invalid characters

            // Limit the alias length to 30 characters
            if (alias.length > 30) {
                alias = alias.substring(0, 30);
            }
        }

        let apiUrl = `https://marko-app.netlify.app/s/?redirectpath=${encodeURIComponent(url)}&owner=${encodeURIComponent(owner)}`;
        if (alias) apiUrl += `&path=${encodeURIComponent(alias)}`;
        if (once) apiUrl += '&once=true';
        if (expires) apiUrl += `&expires=${encodeURIComponent(expires)}`;
        if (password) apiUrl += `&password=${encodeURIComponent(password)}`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const { path, redirectPath, expires, once } = data;
                const fullPath = `https://marko-app.netlify.app/o/${path}`;

                resultMessage.innerHTML = `
                    Shortlink created: <a href="${fullPath}" target="_blank" class="fullpath" onclick="handleFullPathClick('${fullPath}')">${fullPath}</a><br>
                    Redirect Path: <a href="${redirectPath}" target="_blank" class="redirectpath">${redirectPath}</a><br>
                    Expiration: ${expires}<br>${once ? 'One-time use only' : ''}<br>${password ? 'Password-protected' : ''}
                `;

                createForm.classList.add('hidden');
                result.classList.remove('hidden');

                // Show or hide buttons based on 'once' value
                if (once) {
                    testBtn.classList.add('hidden');
                    resultMessage.insertAdjacentHTML('beforeend', '<p>Opening this link will invalidate it.</p>');
                } else {
                    testBtn.classList.remove('hidden');
                    testBtn.addEventListener('click', () => window.open(fullPath, '_blank'));
                }

                restartBtn.classList.remove('hidden');

                saveShortlink({
                    shortlink: path, 
                    redirectPath: url,
                    expires: expires,
                    once: once ? 'true' : 'false',
                    password: password || '' 
                });
                updateLinkList();
            })
            .catch(error => console.error('Error:', error));
    }

    function saveShortlink(data) {
        const shortlinks = JSON.parse(localStorage.getItem('shortlinks') || '[]');
        shortlinks.push([
            data.shortlink, 
            data.redirectPath,
            data.expires || '',
            data.once ? 'true' : 'false',
            data.password
        ]);
        localStorage.setItem('shortlinks', JSON.stringify(shortlinks));
    }

    function updateLinkList() {
        linkList.innerHTML = '';
        const shortlinks = JSON.parse(localStorage.getItem('shortlinks') || '[]');
        shortlinks.forEach((link, index) => {
            const li = document.createElement('li');
            const now = new Date();
            const expired = link[2] && new Date(link[2]) < now;
            const fullPath = `https://marko-app.netlify.app/o/${link[0]}`;
            const redirectPath = link[1];
            const hasPassword = link[4]; 
            const password = hasPassword ? link[4] : '';
            const expires = link[2];
            const once = link[3] === 'true';

            // Determine expiration status
            let expirationIcon = '';
            if (expires) {
                const expirationDate = new Date(expires);
                const fourYearsLater = new Date();
                fourYearsLater.setFullYear(now.getFullYear() + 4);
                if (expirationDate < fourYearsLater) {
                    expirationIcon = `<i class="material-icons" style="cursor: pointer;" onclick="showExpiration('${expires}')">schedule</i>`;
                }
            }

            // Determine once status
            let onceIcon = '';
            if (once) {
                onceIcon = `<i class="material-icons" id="onceIcon" title="This is a one-time link, click here to see if it has already been used">repeat_one</i>`;
            }

            li.innerHTML = `
    ${index + 1}. 
    <span class="fullpath" onclick="handleFullPathClick('${fullPath}')">${fullPath}</span><br>
    Redirect Path: 
    <a href="${redirectPath}" target="_blank" class="redirectpath">${redirectPath}</a><br>
    ${hasPassword ? `
        <span class="password-container">
            <i class="material-icons" style="cursor: pointer;" onclick="revealPassword('${password}', this)">lock</i>
            <span class="password hidden">${password}</span>
            ${once ? onceIcon : ''}
            ${expirationIcon}
        </span>` : ''}
            `;
            if (expired) li.classList.add('expired');
            if (once) li.classList.add('once');
            linkList.appendChild(li);
        });
    }
 // Select all icons with id starting with 'onceIcon-'
const icons = document.querySelectorAll('[id="onceIcon"]');

// Add an onclick event listener to each icon
icons.forEach(icon => {
    icon.onclick = function() {
        // Find the closest li element
        const closestLi = this.closest('li');

        // Get path and redirectPath from the 'redirectpath' link in the same li element
        const storedFullPath = closestLi.querySelector('.path').href;
        const baseShortUrl = "https://marko-app.netlify.app/o/";
        const path = storedFullPath.replace(baseShortUrl, '');        
        const storedRedirectPath = closestLi.querySelector('.redirectpath').href;

        // Query the Firebase Realtime Database
        const shortlinkRef = firebase.database().ref('shortlink/' + path);

        shortlinkRef.once('value').then(snapshot => {
            const shortlinkData = snapshot.val();
            
            if (shortlinkData) {
                const { redirectPath } = shortlinkData;

                // Check if the stored redirectPath matches the one in the database
                if (redirectPath === storedRedirectPath) {
                    alert('Your shortlink has not been clicked yet.');
                    // Additional logic for handling this case can be added here
                } else {
                    alert('Target url does not match. Your shortlink probably has been used and now somebody else uses same alias');
                }
            } else {
                alert('This shortlink does not exist. It was probably a once--only shortlink and has already been clicked');
            }
        }).catch(error => {
            console.error('Error querying database:', error);
        });
    };
});


    window.revealPassword = function(password, iconElement) {
        // Find the password span element
        const passwordSpan = iconElement.nextElementSibling;

        // Show password for 10 seconds
        passwordSpan.classList.add('visible');
        setTimeout(() => {
            passwordSpan.classList.remove('visible');
        }, 10000); // Password visible for 10 seconds

        // Find the full path link
        const fullPathElement = iconElement.closest('li').querySelector('.fullpath');
        if (fullPathElement) {
            const shortlinkWithPassword = `${fullPathElement.href}?password=${encodeURIComponent(password)}`;
            
            // Use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: 'Here is my password-protected shortlink',
                    text: localStorage.getItem('shareMessage') || 'This is only for you',
                    url: shortlinkWithPassword
                }).catch(error => console.error('Error sharing:', error));
            } else {
                // Fallback to clipboard copy
                navigator.clipboard.writeText(shortlinkWithPassword)
                    .then(() => alert('Shortlink with password copied to clipboard'))
                    .catch(error => console.error('Error copying to clipboard:', error));
            }
        } else {
            console.error('Full path link not found');
        }
    };

    window.showExpiration = function(expirationDate) {
        alert(`Expires: ${new Date(expirationDate).toLocaleString()}`);
    };

    window.handleFullPathClick = function(fullPath) {
        const shareMessage = localStorage.getItem('shareMessage') || 'Check out this link!';
        const shortlinkWithPassword = fullPath;

        if (navigator.share) {
            navigator.share({
                title: 'Here is a shortlink',
                text: shareMessage,
                url: shortlinkWithPassword
            }).catch(error => console.error('Error sharing:', error));
        } else {
            // Fallback to clipboard copy
            navigator.clipboard.writeText(shortlinkWithPassword)
                .then(() => alert('Shortlink copied to clipboard'))
                .catch(error => console.error('Error copying to clipboard:', error));
        }
    };

    // Set min and max date for expiry date picker
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const fiveYearsLater = new Date();
    fiveYearsLater.setFullYear(fiveYearsLater.getFullYear() + 5);
    expiryDate.min = tomorrow.toISOString().split('T')[0];
    expiryDate.max = fiveYearsLater.toISOString().split('T')[0];

    // Load previously saved share message from local storage
    const savedShareMessage = localStorage.getItem('shareMessage') || '';
    if (savedShareMessage) {
        document.getElementById('shareMessageInput').value = savedShareMessage;
    }

    // Save share message to local storage when changed
    document.getElementById('shareMessageInput').addEventListener('input', (event) => {
        localStorage.setItem('shareMessage', event.target.value);
    });

    updateLinkList();
});


    </script>
</body>
</html>

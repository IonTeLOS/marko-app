<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Google Drive JSON Writer with GIS</title>
    <!-- Load the Google APIs client library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Load the Google Identity Services library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
        }
        #signout_button {
            display: none;
        }
        #content {
            white-space: pre-wrap;
            background-color: #f1f1f1;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .spinning {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        .input-group input {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>Google Drive JSON Writer with GIS</h1>

    <!-- Authorization Buttons -->
    <button id="authorize_button">Authorize</button>
    <button id="signout_button">Sign Out</button>

    <!-- Message Input -->
    <div class="input-group">
        <label for="message_input">Enter your message:</label>
        <input type="text" id="message_input" placeholder="Your custom message here">
    </div>

    <!-- Action Buttons -->
    <button id="saveToDrive">Save to Google Drive</button>
    <button id="makePublic">Make File Public</button>

    <!-- Content Display -->
    <pre id="content"></pre>

    <script>
        // Your actual Client ID and API Key
        const CLIENT_ID = '371617464258-ntrqn44lfo1lpi294hmc5ebad5b9ok5a.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAbf0IPLaP6Cbbx3NnFlfzcWQ-zxIc5S8E';

        // Scopes required for the application
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';

        // File configurations
        const FILE_NAME = 'bookmarksMarko.json';
        const APP_ID = 'marko';

        let tokenClient;
        let accessToken = null;

        /**
         * Initialize the Google Identity Services and GAPI client
         */
        async function initializeGoogleIdentity() {
            // Initialize the token client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        localStorage.setItem('accessToken', accessToken);
                        console.log('Authorization successful.');
                        appendPre('Authorization successful.');
                        document.getElementById('authorize_button').style.display = 'none';
                        document.getElementById('signout_button').style.display = 'block';
                    } else {
                        console.error('Authorization failed:', tokenResponse);
                        appendPre('Authorization failed.');
                    }
                },
            });

            // Load the GAPI client
            await new Promise((resolve) => {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                        });
                        console.log('GAPI client initialized.');
                        appendPre('GAPI client initialized.');
                        resolve();
                    } catch (error) {
                        console.error('Error initializing GAPI client:', error);
                        appendPre('Error initializing GAPI client.');
                        resolve(); // Resolve to continue even if GAPI fails
                    }
                });
            });
        }

        /**
         * Handle authorization button click
         */
        function authorize() {
            if (!tokenClient) {
                console.error('Token client not initialized.');
                appendPre('Token client not initialized.');
                return;
            }
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        /**
         * Handle sign-out button click
         */
        function signOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    localStorage.removeItem('accessToken');
                    appendPre('User signed out.');
                    document.getElementById('authorize_button').style.display = 'block';
                    document.getElementById('signout_button').style.display = 'none';
                });
            }
        }

        /**
         * Append messages to the content pre element
         * @param {string} message 
         */
        function appendPre(message) {
            const pre = document.getElementById('content');
            const textContent = document.createTextNode(message + '\n');
            pre.appendChild(textContent);
        }

        /**
         * Find existing file in Google Drive
         * @returns {Promise<string|null>} Returns file ID if found, else null
         */
        function findExistingFile() {
            const query = `name='${FILE_NAME}' and trashed=false and properties has { key='appId' and value='${APP_ID}' }`;
            return gapi.client.drive.files.list({
                'q': query,
                'fields': 'files(id, name)',
                'pageSize': 10
            }).then(response => {
                const files = response.result.files;
                if (files && files.length > 0) {
                    console.log('File found:', files[0]);
                    appendPre(`File '${FILE_NAME}' found. ID: ${files[0].id}`);
                    return files[0].id;
                } else {
                    console.log('No existing file found.');
                    appendPre(`No existing file named '${FILE_NAME}' found.`);
                    return null;
                }
            }).catch(error => {
                console.error('Error finding file:', error);
                appendPre(`Error finding file: ${error.message}`);
                throw error;
            });
        }

        /**
         * Create a new file in Google Drive
         * @param {string} content 
         * @returns {Promise<string>} Returns file ID upon creation
         */
        function createNewFile(content) {
            const metadata = {
                'name': FILE_NAME,
                'mimeType': 'application/json',
                'properties': {
                    'appId': APP_ID
                }
            };
            const file = new Blob([content], {type: 'application/json'});

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form,
            }).then(response => response.json())
              .then(data => {
                  console.log('File created:', data);
                  appendPre(`File created with ID: ${data.id}`);
                  return data.id;
              }).catch(error => {
                  console.error('Error creating file:', error);
                  appendPre(`Error creating file: ${error.message}`);
                  throw error;
              });
        }

        /**
         * Update an existing file in Google Drive
         * @param {string} fileId 
         * @param {string} content 
         * @returns {Promise<Object>}
         */
        function updateFile(fileId, content) {
            const file = new Blob([content], {type: 'application/json'});

            return fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }),
                body: content,
            }).then(response => response.json())
              .then(data => {
                  console.log('File updated:', data);
                  appendPre('File updated successfully.');
                  return data;
              }).catch(error => {
                  console.error('Error updating file:', error);
                  appendPre(`Error updating file: ${error.message}`);
                  throw error;
              });
        }

        /**
         * Make the file globally readable
         * @param {string} fileId 
         * @returns {Promise<void>}
         */
        function makeFilePublic(fileId) {
            const permission = {
                'role': 'reader',
                'type': 'anyone'
            };

            return gapi.client.drive.permissions.create({
                fileId: fileId,
                resource: permission,
                fields: 'id',
            }).then(response => {
                console.log('Permission granted:', response);
                appendPre('File is now publicly readable.');
            }).catch(error => {
                console.error('Error making file public:', error);
                appendPre(`Error making file public: ${error.message}`);
                throw error;
            });
        }

        /**
         * Save data to Google Drive
         */
        async function saveToGoogleDrive() {
            const message = document.getElementById('message_input').value.trim();
            if (!message) {
                alert('Please enter a message before saving.');
                return;
            }

            const bookmarksJson = {
                datetime: new Date().toISOString(),
                message: message,
                specialfield: "exampleField",
                specialvalue: "exampleValue"
            };

            const content = JSON.stringify(bookmarksJson, null, 2);

            appendPre('Starting save operation...');
            try {
                let fileId = await findExistingFile();
                if (fileId) {
                    await updateFile(fileId, content);
                } else {
                    fileId = await createNewFile(content);
                }
                alert('Bookmarks saved to Google Drive successfully.');
            } catch (error) {
                console.error('Error saving to Google Drive:', error);
                alert('Failed to save bookmarks to Google Drive.');
            }
        }

        /**
         * Make the file public
         */
        async function handleMakePublic() {
            appendPre('Attempting to make file public...');
            try {
                const fileId = await findExistingFile();
                if (fileId) {
                    await makeFilePublic(fileId);
                    alert('File is now publicly readable.');
                } else {
                    alert('No existing file found to make public.');
                }
            } catch (error) {
                console.error('Error making file public:', error);
                alert('Failed to make file public.');
            }
        }

        /**
         * Initialize everything once the DOM is loaded
         */
        document.addEventListener('DOMContentLoaded', () => {
            initializeGoogleIdentity();

            // Set up button event listeners
            document.getElementById('authorize_button').addEventListener('click', () => {
                authorize();
                // The callback in tokenClient will handle button visibility
            });

            document.getElementById('signout_button').addEventListener('click', signOut);
            document.getElementById('saveToDrive').addEventListener('click', saveToGoogleDrive);
            document.getElementById('makePublic').addEventListener('click', handleMakePublic);

            // Check if user is already authorized
            const storedToken = localStorage.getItem('accessToken');
            if (storedToken) {
                accessToken = storedToken;
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'block';
                appendPre('Already authorized.');
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser Video Compressor (Canvas)</title>
</head>
<body>
<h2>In-Browser Video Compressor (Canvas)</h2>

<input type="file" id="videoInput" accept="video/*" />
<button id="compressBtn">Compress Video</button>
<p id="status"></p>
<a id="downloadLink" style="display:none;">Download Compressed Video</a>

<video id="hiddenVideo" style="display:none"></video>
<canvas id="canvas" style="display:none"></canvas>

<script>
const videoInput = document.getElementById('videoInput');
const compressBtn = document.getElementById('compressBtn');
const statusEl = document.getElementById('status');
const downloadLink = document.getElementById('downloadLink');

const hiddenVideo = document.getElementById('hiddenVideo');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

compressBtn.addEventListener('click', async () => {
    if (!videoInput.files.length) return alert('Please select a video first!');
    const file = videoInput.files[0];
    
    statusEl.textContent = 'Loading video...';

    const videoURL = URL.createObjectURL(file);
    hiddenVideo.src = videoURL;

    await hiddenVideo.play().catch(()=>{}); // required for metadata loading in some browsers

    // Set canvas size (reduce resolution for compression)
    const targetWidth = 720;
    const aspectRatio = hiddenVideo.videoHeight / hiddenVideo.videoWidth;
    const targetHeight = Math.floor(targetWidth * aspectRatio);
    canvas.width = targetWidth;
    canvas.height = targetHeight;

    statusEl.textContent = 'Recording compressed video...';

    const stream = canvas.captureStream(30); // 30fps
    const recordedChunks = [];
    const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });

    mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const downloadURL = URL.createObjectURL(blob);

        downloadLink.href = downloadURL;
        downloadLink.download = 'compressed.webm';
        downloadLink.style.display = 'block';
        downloadLink.textContent = 'Download Compressed Video';

        statusEl.textContent = 'Compression complete!';
    };

    mediaRecorder.start(100); // collect data every 100ms

    // Draw video frames to canvas
    function drawFrame() {
        if (hiddenVideo.paused || hiddenVideo.ended) {
            mediaRecorder.stop();
            return;
        }
        ctx.drawImage(hiddenVideo, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(drawFrame);
    }
    drawFrame();
});
</script>
</body>
</html>
